<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="bigfly">
    
    <title>
        
            RCNN代码复现 |
        
        BigflyのBlog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/regular.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/solid.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/font/css/brands.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066cc","logo":"/images/head.jpg","favicon":"/images/logo.svg","avatar":"/images/head.jpg","font_size":null,"font_family":null,"hover":{"shadow":true,"scale":false},"first_screen":{"enable":false,"header_transparent":false,"background_img":"/images/bg.svg","description":"Stay hungry, Stay foolish.","font_color":null,"hitokoto":false},"scroll":{"progress_bar":true,"percent":false}},"local_search":{"enable":true,"preload":true},"code_copy":{},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"side_tools":{},"pjax":{"enable":true},"lazyload":{"enable":true},"comment":{"enable":false,"use":"twikoo","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":"欢迎大家评论留言："},"gitalk":{"github_id":"bigflya","github_admins":null,"repository":"blogcomment","client_id":"316266297ae09f8db378","client_secret":"463a369b390196542f5f4369654d53e8f00a75b8","proxy":null},"twikoo":{"env_id":"https://bigflya.zeabur.app","region":null,"version":"1.6.16"},"waline":{"server_url":null,"reaction":null,"version":2}},"post":{"author_label":{"enable":true,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"enable":true,"wordcount":true,"min2read":true},"img_align":"center","copyright_info":true},"version":"3.6.1"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/images/head.jpg">
                </a>
            
            <a class="logo-title" href="/">
               BigflyのBlog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/links"
                            >
                                友链
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                关于
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/CodeModules"
                            >
                                CODE
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/links">友链</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">关于</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/CodeModules">CODE</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">

            <div class="article-title">
                <span class="title-hover-animation">RCNN代码复现</span>
            </div>

            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/images/head.jpg">
                    </div>
                    <div class="info">
                        <div class="author">
                            <span class="name">bigfly</span>
                            
                                <span class="author-label">Lv4</span>
                            
                        </div>
                        <div class="meta-info">
                            
<div class="article-meta-info">
    <span class="article-date article-meta-item">
        
            <i class="fa-regular fa-calendar-plus"></i>&nbsp;
        
        <span class="pc">2023-04-21 23:26:11</span>
        <span class="mobile">2023-04-21 23:26</span>
    </span>
    
        <span class="article-update-date article-meta-item">
        <i class="fas fa-file-pen"></i>&nbsp;
        <span class="pc">2023-04-21 23:26:11</span>
    </span>
    
    
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>9.7k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>55 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content keep-markdown-body">
                

                <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="一、工程结构"><a href="#一、工程结构" class="headerlink" title="一、工程结构"></a>一、工程结构</h2><p><img  
                     lazyload
                     alt="image"
                     data-src="https://blogimg-1258792233.cos.ap-beijing.myqcloud.com/20230421221751.png"
                     
                ></p>
<h2 id="二、源码解读"><a href="#二、源码解读" class="headerlink" title="二、源码解读"></a>二、源码解读</h2><h3 id="py-x2F"><a href="#py-x2F" class="headerlink" title="py&#x2F;"></a>py&#x2F;</h3><h4 id="bbox-regression-py"><a href="#bbox-regression-py" class="headerlink" title="bbox_regression.py"></a>bbox_regression.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">from</span> torchvision.models <span class="keyword">import</span> AlexNet</span><br><span class="line"><span class="keyword">from</span> visdom <span class="keyword">import</span> Visdom</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.data.custom_bbox_regression_dataset <span class="keyword">import</span> BBoxRegressionDataset</span><br><span class="line"><span class="keyword">import</span> utils.util <span class="keyword">as</span> util</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_data</span>(<span class="params">data_root_dir</span>):</span><br><span class="line">    transform = transforms.Compose([</span><br><span class="line">        transforms.ToPILImage(),</span><br><span class="line">        transforms.Resize((<span class="number">227</span>, <span class="number">227</span>)),</span><br><span class="line">        transforms.RandomHorizontalFlip(),</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line">        transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>))</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    data_set = BBoxRegressionDataset(data_root_dir, transform=transform)</span><br><span class="line">    data_loader = DataLoader(data_set, batch_size=<span class="number">128</span>, shuffle=<span class="literal">True</span>, num_workers=<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data_loader</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train_model</span>(<span class="params">data_loader, feature_model, model, criterion, optimizer, lr_scheduler, num_epochs=<span class="number">25</span>, device=<span class="literal">None</span></span>):</span><br><span class="line">    since = time.time()</span><br><span class="line"></span><br><span class="line">    model.train()  <span class="comment"># Set model to training mode</span></span><br><span class="line">    loss_list = <span class="built_in">list</span>()</span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Epoch &#123;&#125;/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(epoch, num_epochs - <span class="number">1</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">10</span>)</span><br><span class="line">        viz = Visdom()  <span class="comment"># 初始化visdom类</span></span><br><span class="line">        viz.line(Y=[<span class="number">0.</span>], X=[<span class="number">0.</span>], win=<span class="string">&quot;train loss&quot;</span>,opts=<span class="built_in">dict</span>(title=<span class="string">&#x27;train loss&#x27;</span>, xlabel=<span class="string">&#x27;epoch&#x27;</span>, ylabel=<span class="string">&#x27;loss&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        running_loss = <span class="number">0.0</span></span><br><span class="line">        batch_i = <span class="number">0</span></span><br><span class="line">        <span class="comment"># Iterate over data.</span></span><br><span class="line">        <span class="keyword">for</span> inputs, targets <span class="keyword">in</span> data_loader:</span><br><span class="line">            inputs = inputs.to(device)</span><br><span class="line">            targets = targets.<span class="built_in">float</span>().to(device)</span><br><span class="line"></span><br><span class="line">            features = feature_model.features(inputs)</span><br><span class="line">            features = torch.flatten(features, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># zero the parameter gradients</span></span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># forward</span></span><br><span class="line">            outputs = model(features)</span><br><span class="line">            loss = criterion(outputs, targets)</span><br><span class="line"></span><br><span class="line">            loss.backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># statistics</span></span><br><span class="line">            running_loss += loss.item() * inputs.size(<span class="number">0</span>)</span><br><span class="line">            lr_scheduler.step()</span><br><span class="line"></span><br><span class="line">            batch_i += <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;batch&quot;</span>, batch_i, <span class="string">&quot;running_loss_adds=&quot;</span>, running_loss)</span><br><span class="line"></span><br><span class="line">        epoch_loss = running_loss / data_loader.dataset.__len__()</span><br><span class="line">        loss_list.append(epoch_loss)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125; Loss: &#123;:.4f&#125;&#x27;</span>.<span class="built_in">format</span>(epoch, epoch_loss))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 绘制回归损失图</span></span><br><span class="line">        viz.line(Y=[epoch_loss], X=[epoch + <span class="number">1</span>],win=<span class="string">&quot;train loss&quot;</span>,opts=<span class="built_in">dict</span>(title=<span class="string">&#x27;train loss&#x27;</span>, xlabel=<span class="string">&#x27;epoch&#x27;</span>, ylabel=<span class="string">&#x27;loss&#x27;</span>, update=<span class="string">&quot;append&quot;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 每训练一轮就保存</span></span><br><span class="line">        util.save_model(model, <span class="string">&#x27;./models/bbox_regression_%d.pth&#x27;</span> % epoch)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line">    time_elapsed = time.time() - since</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Training complete in &#123;:.0f&#125;m &#123;:.0f&#125;s&#x27;</span>.<span class="built_in">format</span>(time_elapsed // <span class="number">60</span>, time_elapsed % <span class="number">60</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> loss_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_model</span>(<span class="params">device=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="comment"># 加载CNN模型</span></span><br><span class="line">    model = AlexNet(num_classes=<span class="number">2</span>)</span><br><span class="line">    model.load_state_dict(torch.load(<span class="string">&#x27;./models/best_linear_svm_alexnet_car.pth&#x27;</span>))</span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 取消梯度追踪</span></span><br><span class="line">    <span class="keyword">for</span> param <span class="keyword">in</span> model.parameters():</span><br><span class="line">        param.requires_grad = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> device:</span><br><span class="line">        model = model.to(device)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    data_loader = load_data(<span class="string">&#x27;./data/bbox_regression&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    device = torch.device(<span class="string">&quot;cuda:0&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">    feature_model = get_model(device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># AlexNet最后一个池化层计算得到256*6*6输出</span></span><br><span class="line">    in_features = <span class="number">256</span> * <span class="number">6</span> * <span class="number">6</span></span><br><span class="line">    out_features = <span class="number">4</span></span><br><span class="line">    model = nn.Linear(in_features, out_features)</span><br><span class="line">    model.to(device)</span><br><span class="line"></span><br><span class="line">    criterion = nn.MSELoss()</span><br><span class="line">    optimizer = optim.Adam(model.parameters(), lr=<span class="number">1e-4</span>, weight_decay=<span class="number">1e-4</span>)</span><br><span class="line">    lr_scheduler = optim.lr_scheduler.StepLR(optimizer, step_size=<span class="number">5</span>, gamma=<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">    loss_list = train_model(data_loader, feature_model, model, criterion, optimizer, lr_scheduler, device=device,</span><br><span class="line">                            num_epochs=<span class="number">5</span>)</span><br><span class="line">    util.plot_loss(loss_list)</span><br></pre></td></tr></table></figure>



<h4 id="car-detector-py"><a href="#car-detector-py" class="headerlink" title="car_detector.py"></a>car_detector.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torchvision.models <span class="keyword">import</span> alexnet</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">import</span> selectivesearch</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> utils.util <span class="keyword">as</span> util</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_device</span>():</span><br><span class="line">    <span class="keyword">return</span> torch.device(<span class="string">&#x27;cuda:0&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_transform</span>():</span><br><span class="line">    <span class="comment"># 数据转换</span></span><br><span class="line">    transform = transforms.Compose([</span><br><span class="line">        transforms.ToPILImage(),</span><br><span class="line">        transforms.Resize((<span class="number">227</span>, <span class="number">227</span>)),</span><br><span class="line">        transforms.RandomHorizontalFlip(),</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line">        transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>))</span><br><span class="line">    ])</span><br><span class="line">    <span class="keyword">return</span> transform</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_model</span>(<span class="params">device=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="comment"># 加载CNN模型</span></span><br><span class="line">    model = alexnet()</span><br><span class="line">    num_classes = <span class="number">2</span></span><br><span class="line">    num_features = model.classifier[<span class="number">6</span>].in_features</span><br><span class="line">    model.classifier[<span class="number">6</span>] = nn.Linear(num_features, num_classes)</span><br><span class="line">    model.load_state_dict(torch.load(<span class="string">&#x27;./models/best_linear_svm_alexnet_car.pth&#x27;</span>))</span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 取消梯度追踪</span></span><br><span class="line">    <span class="keyword">for</span> param <span class="keyword">in</span> model.parameters():</span><br><span class="line">        param.requires_grad = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> device:</span><br><span class="line">        model = model.to(device)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_box_with_text</span>(<span class="params">img, rect_list, score_list</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    绘制边框及其分类概率</span></span><br><span class="line"><span class="string">    :param img:</span></span><br><span class="line"><span class="string">    :param rect_list:</span></span><br><span class="line"><span class="string">    :param score_list:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(rect_list)):</span><br><span class="line">        xmin, ymin, xmax, ymax = rect_list[i]</span><br><span class="line">        score = score_list[i]</span><br><span class="line"></span><br><span class="line">        cv2.rectangle(img, (xmin, ymin), (xmax, ymax), color=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), thickness=<span class="number">1</span>)</span><br><span class="line">        cv2.putText(img, <span class="string">&quot;&#123;:.3f&#125;&quot;</span>.<span class="built_in">format</span>(score), (xmin, ymin), cv2.FONT_HERSHEY_SIMPLEX, <span class="number">0.5</span>, (<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>), <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nms</span>(<span class="params">rect_list, score_list</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    非最大抑制</span></span><br><span class="line"><span class="string">    :param rect_list: list，大小为[N, 4]</span></span><br><span class="line"><span class="string">    :param score_list： list，大小为[N]</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    nms_rects = <span class="built_in">list</span>()</span><br><span class="line">    nms_scores = <span class="built_in">list</span>()</span><br><span class="line"></span><br><span class="line">    rect_array = np.array(rect_list)</span><br><span class="line">    score_array = np.array(score_list)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 一次排序后即可</span></span><br><span class="line">    <span class="comment"># 按分类概率从大到小排序</span></span><br><span class="line">    idxs = np.argsort(score_array)[::-<span class="number">1</span>]</span><br><span class="line">    rect_array = rect_array[idxs]</span><br><span class="line">    score_array = score_array[idxs]</span><br><span class="line"></span><br><span class="line">    thresh = <span class="number">0.15</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(score_array) &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 添加分类概率最大的边界框</span></span><br><span class="line">        nms_rects.append(rect_array[<span class="number">0</span>])</span><br><span class="line">        nms_scores.append(score_array[<span class="number">0</span>])</span><br><span class="line">        rect_array = rect_array[<span class="number">1</span>:]</span><br><span class="line">        score_array = score_array[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">        length = <span class="built_in">len</span>(score_array)</span><br><span class="line">        <span class="keyword">if</span> length &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算IoU</span></span><br><span class="line">        iou_scores = util.iou(np.array(nms_rects[<span class="built_in">len</span>(nms_rects) - <span class="number">1</span>]), rect_array)</span><br><span class="line">        <span class="comment"># print(iou_scores)</span></span><br><span class="line">        <span class="comment"># 去除重叠率大于等于thresh的边界框</span></span><br><span class="line">        idxs = np.where(iou_scores &lt; thresh)[<span class="number">0</span>]</span><br><span class="line">        rect_array = rect_array[idxs]</span><br><span class="line">        score_array = score_array[idxs]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nms_rects, nms_scores</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    device = get_device()</span><br><span class="line">    transform = get_transform()</span><br><span class="line">    model = get_model(device=device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建selectivesearch对象</span></span><br><span class="line">    gs = selectivesearch.get_selective_search()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#test_img_path = &#x27;../imgs/000007.jpg&#x27;</span></span><br><span class="line">    <span class="comment"># test_xml_path = &#x27;../imgs/000007.xml&#x27;</span></span><br><span class="line">    test_img_path = <span class="string">&#x27;../imgs/456.jpg&#x27;</span></span><br><span class="line">    <span class="comment">#test_xml_path = &#x27;../imgs/000012.xml&#x27;</span></span><br><span class="line"></span><br><span class="line">    img = cv2.imread(test_img_path)</span><br><span class="line">    dst = copy.deepcopy(img)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># bndboxs = util.parse_xml(test_xml_path)</span></span><br><span class="line">    <span class="comment"># for bndbox in bndboxs:</span></span><br><span class="line">    <span class="comment">#    xmin, ymin, xmax, ymax = bndbox</span></span><br><span class="line">    <span class="comment">#    cv2.rectangle(dst, (xmin, ymin), (xmax, ymax), color=(0, 255, 0), thickness=1)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 候选区域建议</span></span><br><span class="line">    selectivesearch.config(gs, img, strategy=<span class="string">&#x27;f&#x27;</span>)</span><br><span class="line">    rects = selectivesearch.get_rects(gs)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;候选区域建议数目： %d&#x27;</span> % <span class="built_in">len</span>(rects))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># softmax = torch.softmax()</span></span><br><span class="line"></span><br><span class="line">    svm_thresh = <span class="number">0.55</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存正样本边界框以及</span></span><br><span class="line">    score_list = <span class="built_in">list</span>()</span><br><span class="line">    positive_list = <span class="built_in">list</span>()</span><br><span class="line"></span><br><span class="line">    tmp_score_list = <span class="built_in">list</span>()</span><br><span class="line">    tmp_positive_list = <span class="built_in">list</span>()</span><br><span class="line">    start = time.time()</span><br><span class="line">    <span class="keyword">for</span> rect <span class="keyword">in</span> rects:</span><br><span class="line">        xmin, ymin, xmax, ymax = rect</span><br><span class="line">        rect_img = img[ymin:ymax, xmin:xmax]</span><br><span class="line"></span><br><span class="line">        rect_transform = transform(rect_img).to(device)</span><br><span class="line">        output = model(rect_transform.unsqueeze(<span class="number">0</span>))[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> torch.argmax(output).item() == <span class="number">1</span>:</span><br><span class="line">            <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            预测为汽车</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            probs = torch.softmax(output, dim=<span class="number">0</span>).cpu().numpy()</span><br><span class="line"></span><br><span class="line">            tmp_score_list.append(probs[<span class="number">1</span>])</span><br><span class="line">            tmp_positive_list.append(rect)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> probs[<span class="number">1</span>] &gt;= svm_thresh:</span><br><span class="line">                score_list.append(probs[<span class="number">1</span>])</span><br><span class="line">                positive_list.append(rect)</span><br><span class="line">                <span class="comment"># cv2.rectangle(dst, (xmin, ymin), (xmax, ymax), color=(0, 0, 255), thickness=2)</span></span><br><span class="line">                <span class="built_in">print</span>(rect, output, probs)</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;detect time: %d s&#x27;</span> % (end - start))</span><br><span class="line"></span><br><span class="line">    tmp_img2 = copy.deepcopy(dst)</span><br><span class="line">    draw_box_with_text(tmp_img2, tmp_positive_list, tmp_score_list)</span><br><span class="line">    cv2.imshow(<span class="string">&#x27;1&#x27;</span>, tmp_img2)</span><br><span class="line"></span><br><span class="line">    tmp_img = copy.deepcopy(dst)</span><br><span class="line">    draw_box_with_text(tmp_img, positive_list, score_list)</span><br><span class="line">    cv2.imshow(<span class="string">&#x27;2&#x27;</span>, tmp_img)</span><br><span class="line"></span><br><span class="line">    nms_rects, nms_scores = nms(positive_list, score_list)</span><br><span class="line">    <span class="built_in">print</span>(nms_rects)</span><br><span class="line">    <span class="built_in">print</span>(nms_scores)</span><br><span class="line">    draw_box_with_text(dst, nms_rects, nms_scores)</span><br><span class="line"></span><br><span class="line">    cv2.imshow(<span class="string">&#x27;3&#x27;</span>, dst)</span><br><span class="line">    cv2.waitKey(<span class="number">0</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="finetune-py"><a href="#finetune-py" class="headerlink" title="finetune.py"></a>finetune.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">from</span> visdom <span class="keyword">import</span> Visdom</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">import</span> torchvision.models <span class="keyword">as</span> models</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.data.custom_finetune_dataset <span class="keyword">import</span> CustomFinetuneDataset</span><br><span class="line"><span class="keyword">from</span> utils.data.custom_batch_sampler <span class="keyword">import</span> CustomBatchSampler</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> check_dir</span><br><span class="line"><span class="keyword">from</span> image_handler_show <span class="keyword">import</span> show_image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_data</span>(<span class="params">data_root_dir</span>):</span><br><span class="line">    transform = transforms.Compose([</span><br><span class="line">        transforms.ToPILImage(),</span><br><span class="line">        transforms.Resize((<span class="number">227</span>, <span class="number">227</span>)),</span><br><span class="line">        transforms.RandomHorizontalFlip(),</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line">        transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>))</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    data_loaders = &#123;&#125;</span><br><span class="line">    data_sizes = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> [<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;val&#x27;</span>]:</span><br><span class="line">        data_dir = os.path.join(data_root_dir, name)</span><br><span class="line">        data_set = CustomFinetuneDataset(data_dir, transform=transform)</span><br><span class="line">        data_sampler = CustomBatchSampler(data_set.get_positive_num(), data_set.get_negative_num(), <span class="number">32</span>, <span class="number">96</span>)</span><br><span class="line">        data_loader = DataLoader(data_set, batch_size=<span class="number">128</span>, sampler=data_sampler, num_workers=<span class="number">8</span>, drop_last=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        data_loaders[name] = data_loader</span><br><span class="line">        data_sizes[name] = data_sampler.__len__()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data_loaders, data_sizes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train_model</span>(<span class="params">data_loaders, model, criterion, optimizer, lr_scheduler, num_epochs=<span class="number">25</span>, device=<span class="literal">None</span></span>):</span><br><span class="line">    since = time.time()</span><br><span class="line"></span><br><span class="line">    best_model_weights = copy.deepcopy(model.state_dict())</span><br><span class="line">    best_acc = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">    viz = Visdom(env=<span class="string">&#x27;loss and val of trainval&#x27;</span>)  <span class="comment"># 初始化visdom</span></span><br><span class="line">    viz.line(Y=np.column_stack((<span class="number">0.</span>, <span class="number">0.</span>)), X=np.column_stack((<span class="number">0.</span>, <span class="number">0.</span>)), win=<span class="string">&quot;&#123;&#125; loss/acc&quot;</span>.<span class="built_in">format</span>(<span class="string">&#x27;train&#x27;</span>),</span><br><span class="line">             opts=<span class="built_in">dict</span>(title=<span class="string">&#x27;&#123;&#125; loss&amp;acc&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;train&#x27;</span>), xlabel=<span class="string">&#x27;epoch&#x27;</span>, ylabel=<span class="string">&#x27;loss/acc&#x27;</span>,</span><br><span class="line">                       legend=[<span class="string">&quot;loss&quot;</span>, <span class="string">&quot;acc&quot;</span>]))</span><br><span class="line">    viz.line(Y=np.column_stack((<span class="number">0.</span>, <span class="number">0.</span>)), X=np.column_stack((<span class="number">0.</span>, <span class="number">0.</span>)), win=<span class="string">&quot;&#123;&#125; loss/acc&quot;</span>.<span class="built_in">format</span>(<span class="string">&#x27;val&#x27;</span>),</span><br><span class="line">             opts=<span class="built_in">dict</span>(title=<span class="string">&#x27;&#123;&#125; loss&amp;acc&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;val&#x27;</span>), xlabel=<span class="string">&#x27;epoch&#x27;</span>, ylabel=<span class="string">&#x27;loss/acc&#x27;</span>,</span><br><span class="line">                       legend=[<span class="string">&quot;loss&quot;</span>, <span class="string">&quot;acc&quot;</span>]))  <span class="comment"># 初始化起点</span></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Epoch &#123;&#125;/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(epoch, num_epochs))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Each epoch has a training and validation phase</span></span><br><span class="line">        <span class="keyword">for</span> phase <span class="keyword">in</span> [<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;val&#x27;</span>]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> phase == <span class="string">&#x27;train&#x27;</span>:</span><br><span class="line">                model.train()  <span class="comment"># Set model to training mode</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                model.<span class="built_in">eval</span>()  <span class="comment"># Set model to evaluate mode</span></span><br><span class="line"></span><br><span class="line">            running_loss = <span class="number">0.0</span></span><br><span class="line">            running_corrects = <span class="number">0</span></span><br><span class="line">            batch_i = <span class="number">0</span></span><br><span class="line">            <span class="comment"># Iterate over data.</span></span><br><span class="line">            <span class="keyword">for</span> inputs, labels <span class="keyword">in</span> data_loaders[phase]:</span><br><span class="line">                inputs = inputs.to(device)</span><br><span class="line">                labels = labels.to(device)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># zero the parameter gradients</span></span><br><span class="line">                optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line">                <span class="comment"># forward</span></span><br><span class="line">                <span class="comment"># track history if only in train</span></span><br><span class="line">                <span class="keyword">with</span> torch.set_grad_enabled(phase == <span class="string">&#x27;train&#x27;</span>):</span><br><span class="line">                    outputs = model(inputs)</span><br><span class="line">                    _, preds = torch.<span class="built_in">max</span>(outputs, <span class="number">1</span>)</span><br><span class="line">                    loss = criterion(outputs, labels)</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># backward + optimize only if in training phase</span></span><br><span class="line">                    <span class="keyword">if</span> phase == <span class="string">&#x27;train&#x27;</span>:</span><br><span class="line">                        loss.backward()</span><br><span class="line">                        optimizer.step()</span><br><span class="line"></span><br><span class="line">                <span class="comment"># statistics</span></span><br><span class="line">                running_loss += loss.item() * inputs.size(<span class="number">0</span>)</span><br><span class="line">                running_corrects += torch.<span class="built_in">sum</span>(preds == labels.data)</span><br><span class="line">                batch_i += <span class="number">1</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;batch&quot;</span>, batch_i, <span class="string">&quot;running_loss_adds=&quot;</span>, running_loss)</span><br><span class="line">            <span class="keyword">if</span> phase == <span class="string">&#x27;train&#x27;</span>:</span><br><span class="line">                lr_scheduler.step()</span><br><span class="line"></span><br><span class="line">            epoch_loss = running_loss / data_sizes[phase]</span><br><span class="line">            epoch_acc = running_corrects.double() / data_sizes[phase]</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125; Loss: &#123;:.4f&#125; Acc: &#123;:.4f&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                phase, epoch_loss, epoch_acc))</span><br><span class="line"></span><br><span class="line">            viz.line(Y=np.column_stack((epoch_loss, epoch_acc)), X=np.column_stack((epoch + <span class="number">1</span>, epoch + <span class="number">1</span>)),</span><br><span class="line">                     win=<span class="string">&quot;&#123;&#125; loss/acc&quot;</span>.<span class="built_in">format</span>(phase),</span><br><span class="line">                     opts=<span class="built_in">dict</span>(title=<span class="string">&#x27;&#123;&#125; loss&amp;acc&#x27;</span>.<span class="built_in">format</span>(phase), xlabel=<span class="string">&#x27;epoch&#x27;</span>, ylabel=<span class="string">&#x27;loss/acc&#x27;</span>,</span><br><span class="line">                               legend=[<span class="string">&quot;loss&quot;</span>, <span class="string">&quot;acc&quot;</span>]), update=<span class="string">&#x27;append&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># deep copy the model</span></span><br><span class="line">            <span class="keyword">if</span> phase == <span class="string">&#x27;val&#x27;</span> <span class="keyword">and</span> epoch_acc &gt; best_acc:</span><br><span class="line">                best_acc = epoch_acc</span><br><span class="line">                best_model_weights = copy.deepcopy(model.state_dict())</span><br><span class="line"></span><br><span class="line">    time_elapsed = time.time() - since</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Training complete in &#123;:.0f&#125;m &#123;:.0f&#125;s&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">        time_elapsed // <span class="number">60</span>, time_elapsed % <span class="number">60</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Best val Acc: &#123;:4f&#125;&#x27;</span>.<span class="built_in">format</span>(best_acc))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># load best model weights</span></span><br><span class="line">    model.load_state_dict(best_model_weights)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    <span class="comment"># 打印显示</span></span><br><span class="line">    data_loader = data_loaders[<span class="string">&#x27;train&#x27;</span>]</span><br><span class="line">    inputs, targets = <span class="built_in">next</span>(data_loader.__iter__())</span><br><span class="line">    <span class="built_in">print</span>(inputs[<span class="number">0</span>].size(), <span class="built_in">type</span>(inputs[<span class="number">0</span>]))</span><br><span class="line">    trans = transforms.ToPILImage()</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">type</span>(trans(inputs[<span class="number">0</span>])))</span><br><span class="line">    <span class="built_in">print</span>(targets)</span><br><span class="line">    <span class="built_in">print</span>(inputs.shape)</span><br><span class="line">    titles = [<span class="string">&quot;TRUE&quot;</span> <span class="keyword">if</span> i.item() <span class="keyword">else</span> <span class="string">&quot;FALSE&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> targets[<span class="number">0</span>:<span class="number">60</span>]]</span><br><span class="line">    images = [np.array(trans(i)) <span class="keyword">for</span> i <span class="keyword">in</span> inputs[<span class="number">0</span>:<span class="number">60</span>]]</span><br><span class="line">    show_image(images, titles=titles, num_cols=<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    device = torch.device(<span class="string">&quot;cuda:0&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line"></span><br><span class="line">    data_loaders, data_sizes = load_data(<span class="string">&#x27;./data/finetune_car&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    model = models.alexnet(pretrained=<span class="literal">True</span>)  <span class="comment"># 加载前辈们预训练的模型参数</span></span><br><span class="line">    <span class="built_in">print</span>(model)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># show() # title显示有点问题，只能显示最后一张图片的title</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 把alexnet 变成二分类模型，在最后一层改为2分类</span></span><br><span class="line">    num_features = model.classifier[<span class="number">6</span>].in_features</span><br><span class="line">    model.classifier[<span class="number">6</span>] = nn.Linear(num_features, <span class="number">2</span>)</span><br><span class="line">    <span class="comment"># print(model)</span></span><br><span class="line">    model = model.to(device)</span><br><span class="line"></span><br><span class="line">    criterion = nn.CrossEntropyLoss()</span><br><span class="line">    optimizer = optim.SGD(model.parameters(), lr=<span class="number">1e-3</span>, momentum=<span class="number">0.9</span>)</span><br><span class="line">    lr_scheduler = optim.lr_scheduler.StepLR(optimizer, step_size=<span class="number">7</span>, gamma=<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">    best_model = train_model(data_loaders, model, criterion, optimizer, lr_scheduler, device=device, num_epochs=<span class="number">5</span>)</span><br><span class="line">    <span class="comment"># 保存最好的模型参数</span></span><br><span class="line">    check_dir(<span class="string">&#x27;./models&#x27;</span>)</span><br><span class="line">    torch.save(best_model.state_dict(), <span class="string">&#x27;models/alexnet_car.pth&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;done&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="linear-svm-py"><a href="#linear-svm-py" class="headerlink" title="linear_svm.py"></a>linear_svm.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> copy</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">from</span> torchvision.models <span class="keyword">import</span> alexnet</span><br><span class="line"><span class="keyword">from</span> visdom <span class="keyword">import</span> Visdom</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.data.custom_classifier_dataset <span class="keyword">import</span> CustomClassifierDataset</span><br><span class="line"><span class="keyword">from</span> utils.data.custom_hard_negative_mining_dataset <span class="keyword">import</span> CustomHardNegativeMiningDataset</span><br><span class="line"><span class="keyword">from</span> utils.data.custom_batch_sampler <span class="keyword">import</span> CustomBatchSampler</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> check_dir</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> save_model</span><br><span class="line"></span><br><span class="line">batch_positive = <span class="number">32</span></span><br><span class="line">batch_negative = <span class="number">96</span></span><br><span class="line">batch_total = <span class="number">128</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_data</span>(<span class="params">data_root_dir</span>):</span><br><span class="line">    transform = transforms.Compose([</span><br><span class="line">        transforms.ToPILImage(),</span><br><span class="line">        transforms.Resize((<span class="number">227</span>, <span class="number">227</span>)),</span><br><span class="line">        transforms.RandomHorizontalFlip(),</span><br><span class="line">        transforms.ToTensor(),</span><br><span class="line">        transforms.Normalize((<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>), (<span class="number">0.5</span>, <span class="number">0.5</span>, <span class="number">0.5</span>))</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    data_loaders = &#123;&#125;</span><br><span class="line">    data_sizes = &#123;&#125;</span><br><span class="line">    remain_negative_list = <span class="built_in">list</span>()</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> [<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;val&#x27;</span>]:</span><br><span class="line">        data_dir = os.path.join(data_root_dir, name)</span><br><span class="line"></span><br><span class="line">        data_set = CustomClassifierDataset(data_dir, transform=transform)</span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">is</span> <span class="string">&#x27;train&#x27;</span>:</span><br><span class="line">            <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            使用hard negative mining方式</span></span><br><span class="line"><span class="string">            初始正负样本比例为1:1。由于正样本数远小于负样本，所以以正样本数为基准，在负样本集中随机提取同样数目负样本作为初始负样本集</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">            positive_list = data_set.get_positives()</span><br><span class="line">            negative_list = data_set.get_negatives()</span><br><span class="line">            init_negative_idxs = random.sample(<span class="built_in">range</span>(<span class="built_in">len</span>(negative_list)), <span class="built_in">len</span>(positive_list))</span><br><span class="line">            init_negative_list = [negative_list[idx] <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(negative_list)) <span class="keyword">if</span> idx <span class="keyword">in</span> init_negative_idxs]</span><br><span class="line">            remain_negative_list = [negative_list[idx] <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(negative_list))</span><br><span class="line">                                    <span class="keyword">if</span> idx <span class="keyword">not</span> <span class="keyword">in</span> init_negative_idxs]</span><br><span class="line"></span><br><span class="line">            data_set.set_negative_list(init_negative_list)</span><br><span class="line">            data_loaders[<span class="string">&#x27;remain&#x27;</span>] = remain_negative_list</span><br><span class="line"></span><br><span class="line">        sampler = CustomBatchSampler(data_set.get_positive_num(), data_set.get_negative_num(),</span><br><span class="line">                                     batch_positive, batch_negative)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        data_loader = DataLoader(data_set, batch_size=batch_total, sampler=sampler, num_workers=<span class="number">8</span>, drop_last=<span class="literal">True</span>)</span><br><span class="line">        data_loaders[name] = data_loader</span><br><span class="line">        data_sizes[name] = <span class="built_in">len</span>(sampler)</span><br><span class="line">    <span class="keyword">return</span> data_loaders, data_sizes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hinge_loss</span>(<span class="params">outputs, labels</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    折页损失计算</span></span><br><span class="line"><span class="string">    :param outputs: 大小为(N, num_classes)</span></span><br><span class="line"><span class="string">    :param labels: 大小为(N)</span></span><br><span class="line"><span class="string">    :return: 损失值</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    num_labels = <span class="built_in">len</span>(labels)</span><br><span class="line">    corrects = outputs[<span class="built_in">range</span>(num_labels), labels].unsqueeze(<span class="number">0</span>).T</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 最大间隔</span></span><br><span class="line">    margin = <span class="number">1.0</span></span><br><span class="line">    margins = outputs - corrects + margin</span><br><span class="line">    loss = torch.<span class="built_in">sum</span>(torch.<span class="built_in">max</span>(margins, <span class="number">1</span>)[<span class="number">0</span>]) / <span class="built_in">len</span>(labels)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># # 正则化强度</span></span><br><span class="line">    <span class="comment"># reg = 1e-3</span></span><br><span class="line">    <span class="comment"># loss += reg * torch.sum(weight ** 2)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> loss</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_hard_negatives</span>(<span class="params">hard_negative_list, negative_list, add_negative_list</span>):</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> hard_negative_list:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(add_negative_list) == <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># 第一次添加负样本</span></span><br><span class="line">            negative_list.append(item)</span><br><span class="line">            add_negative_list.append(<span class="built_in">list</span>(item[<span class="string">&#x27;rect&#x27;</span>]))</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">list</span>(item[<span class="string">&#x27;rect&#x27;</span>]) <span class="keyword">not</span> <span class="keyword">in</span> add_negative_list:</span><br><span class="line">            negative_list.append(item)</span><br><span class="line">            add_negative_list.append(<span class="built_in">list</span>(item[<span class="string">&#x27;rect&#x27;</span>]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_hard_negatives</span>(<span class="params">preds, cache_dicts</span>):</span><br><span class="line">    fp_mask = preds == <span class="number">1</span></span><br><span class="line">    tn_mask = preds == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    fp_rects = cache_dicts[<span class="string">&#x27;rect&#x27;</span>][fp_mask].numpy()</span><br><span class="line">    fp_image_ids = cache_dicts[<span class="string">&#x27;image_id&#x27;</span>][fp_mask].numpy()</span><br><span class="line"></span><br><span class="line">    tn_rects = cache_dicts[<span class="string">&#x27;rect&#x27;</span>][tn_mask].numpy()</span><br><span class="line">    tn_image_ids = cache_dicts[<span class="string">&#x27;image_id&#x27;</span>][tn_mask].numpy()</span><br><span class="line"></span><br><span class="line">    hard_negative_list = [&#123;<span class="string">&#x27;rect&#x27;</span>: fp_rects[idx], <span class="string">&#x27;image_id&#x27;</span>: fp_image_ids[idx]&#125; <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(fp_rects))]</span><br><span class="line">    easy_negatie_list = [&#123;<span class="string">&#x27;rect&#x27;</span>: tn_rects[idx], <span class="string">&#x27;image_id&#x27;</span>: tn_image_ids[idx]&#125; <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(tn_rects))]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hard_negative_list, easy_negatie_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train_model</span>(<span class="params">data_loaders, model, criterion, optimizer, lr_scheduler, num_epochs=<span class="number">25</span>, device=<span class="literal">None</span></span>):</span><br><span class="line">    since = time.time()</span><br><span class="line"></span><br><span class="line">    best_model_weights = copy.deepcopy(model.state_dict())</span><br><span class="line">    best_acc = <span class="number">0.0</span></span><br><span class="line">    viz = Visdom(env=<span class="string">&#x27;loss and val svm&#x27;</span>)  <span class="comment"># 初始化visdom</span></span><br><span class="line">    viz.line(Y=np.column_stack((<span class="number">0.</span>, <span class="number">0.</span>)), X=np.column_stack((<span class="number">0.</span>, <span class="number">0.</span>)), win=<span class="string">&quot;&#123;&#125; loss/acc&quot;</span>.<span class="built_in">format</span>(<span class="string">&#x27;train&#x27;</span>),</span><br><span class="line">             opts=<span class="built_in">dict</span>(title=<span class="string">&#x27;&#123;&#125; loss&amp;acc&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;train&#x27;</span>), xlabel=<span class="string">&#x27;epoch&#x27;</span>, ylabel=<span class="string">&#x27;loss/acc&#x27;</span>,</span><br><span class="line">                       legend=[<span class="string">&quot;loss&quot;</span>, <span class="string">&quot;acc&quot;</span>]))</span><br><span class="line">    viz.line(Y=np.column_stack((<span class="number">0.</span>, <span class="number">0.</span>)), X=np.column_stack((<span class="number">0.</span>, <span class="number">0.</span>)), win=<span class="string">&quot;&#123;&#125; loss/acc&quot;</span>.<span class="built_in">format</span>(<span class="string">&#x27;val&#x27;</span>),</span><br><span class="line">             opts=<span class="built_in">dict</span>(title=<span class="string">&#x27;&#123;&#125; loss&amp;acc&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;val&#x27;</span>), xlabel=<span class="string">&#x27;epoch&#x27;</span>, ylabel=<span class="string">&#x27;loss/acc&#x27;</span>,</span><br><span class="line">                       legend=[<span class="string">&quot;loss&quot;</span>, <span class="string">&quot;acc&quot;</span>]))  <span class="comment"># 初始化起点</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Epoch &#123;&#125;/&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(epoch, num_epochs ))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;-&#x27;</span> * <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Each epoch has a training and validation phase</span></span><br><span class="line">        <span class="keyword">for</span> phase <span class="keyword">in</span> [<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;val&#x27;</span>]:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> phase == <span class="string">&#x27;train&#x27;</span>:</span><br><span class="line">                model.train()  <span class="comment"># Set model to training mode</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                model.<span class="built_in">eval</span>()  <span class="comment"># Set model to evaluate mode</span></span><br><span class="line"></span><br><span class="line">            running_loss = <span class="number">0.0</span></span><br><span class="line">            running_corrects = <span class="number">0</span></span><br><span class="line">            batch_i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 输出正负样本数</span></span><br><span class="line">            data_set = data_loaders[phase].dataset</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125; - positive_num: &#123;&#125; - negative_num: &#123;&#125; - data size: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                phase, data_set.get_positive_num(), data_set.get_negative_num(), data_sizes[phase]))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Iterate over data.</span></span><br><span class="line">            <span class="keyword">for</span> inputs, labels, cache_dicts <span class="keyword">in</span> data_loaders[phase]:</span><br><span class="line">                inputs = inputs.to(device)</span><br><span class="line">                labels = labels.to(device)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># zero the parameter gradients</span></span><br><span class="line">                optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line">                <span class="comment"># forward</span></span><br><span class="line">                <span class="comment"># track history if only in train</span></span><br><span class="line">                <span class="keyword">with</span> torch.set_grad_enabled(phase == <span class="string">&#x27;train&#x27;</span>):</span><br><span class="line">                    outputs = model(inputs)</span><br><span class="line">                    <span class="comment"># print(outputs.shape)</span></span><br><span class="line">                    _, preds = torch.<span class="built_in">max</span>(outputs, <span class="number">1</span>)</span><br><span class="line">                    loss = criterion(outputs, labels)</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># backward + optimize only if in training phase</span></span><br><span class="line">                    <span class="keyword">if</span> phase == <span class="string">&#x27;train&#x27;</span>:</span><br><span class="line">                        loss.backward()</span><br><span class="line">                        optimizer.step()</span><br><span class="line"></span><br><span class="line">                <span class="comment"># statistics</span></span><br><span class="line">                running_loss += loss.item() * inputs.size(<span class="number">0</span>)</span><br><span class="line">                running_corrects += torch.<span class="built_in">sum</span>(preds == labels.data)</span><br><span class="line">                batch_i += <span class="number">1</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;batch&quot;</span>, batch_i, <span class="string">&quot;running_loss_adds=&quot;</span>, running_loss)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> phase == <span class="string">&#x27;train&#x27;</span>:</span><br><span class="line">                lr_scheduler.step()</span><br><span class="line"></span><br><span class="line">            epoch_loss = running_loss / data_sizes[phase]</span><br><span class="line">            epoch_acc = running_corrects.double() / data_sizes[phase]</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;&#123;&#125; Loss: &#123;:.4f&#125; Acc: &#123;:.4f&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">                phase, epoch_loss, epoch_acc))</span><br><span class="line"></span><br><span class="line">            viz.line(Y=np.column_stack(([epoch_loss], [epoch_acc])), X=np.column_stack(([epoch + <span class="number">1</span>], [epoch + <span class="number">1</span>])),</span><br><span class="line">                     win=<span class="string">&quot;&#123;&#125; loss/acc&quot;</span>.<span class="built_in">format</span>(phase),</span><br><span class="line">                     opts=<span class="built_in">dict</span>(title=<span class="string">&#x27;&#123;&#125; loss&amp;acc&#x27;</span>.<span class="built_in">format</span>(phase), xlabel=<span class="string">&#x27;epoch&#x27;</span>, ylabel=<span class="string">&#x27;loss/acc&#x27;</span>,</span><br><span class="line">                               legend=[<span class="string">&quot;loss&quot;</span>, <span class="string">&quot;acc&quot;</span>]), update=<span class="string">&quot;append&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># deep copy the model</span></span><br><span class="line">            <span class="keyword">if</span> phase == <span class="string">&#x27;val&#x27;</span> <span class="keyword">and</span> epoch_acc &gt; best_acc:</span><br><span class="line">                best_acc = epoch_acc</span><br><span class="line">                best_model_weights = copy.deepcopy(model.state_dict())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 每一轮训练完成后，测试剩余负样本集，进行hard negative mining</span></span><br><span class="line">        train_dataset = data_loaders[<span class="string">&#x27;train&#x27;</span>].dataset</span><br><span class="line">        remain_negative_list = data_loaders[<span class="string">&#x27;remain&#x27;</span>]</span><br><span class="line">        jpeg_images = train_dataset.get_jpeg_images()</span><br><span class="line">        transform = train_dataset.get_transform()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> torch.set_grad_enabled(<span class="literal">False</span>):</span><br><span class="line">            remain_dataset = CustomHardNegativeMiningDataset(remain_negative_list, jpeg_images, transform=transform)</span><br><span class="line">            remain_data_loader = DataLoader(remain_dataset, batch_size=batch_total, num_workers=<span class="number">8</span>, drop_last=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 获取训练数据集的负样本集</span></span><br><span class="line">            negative_list = train_dataset.get_negatives()</span><br><span class="line">            <span class="comment"># 记录后续增加的负样本</span></span><br><span class="line">            add_negative_list = data_loaders.get(<span class="string">&#x27;add_negative&#x27;</span>, [])</span><br><span class="line"></span><br><span class="line">            running_corrects = <span class="number">0</span></span><br><span class="line">            <span class="comment"># Iterate over data.</span></span><br><span class="line">            <span class="keyword">for</span> inputs, labels, cache_dicts <span class="keyword">in</span> remain_data_loader:</span><br><span class="line">                inputs = inputs.to(device)</span><br><span class="line">                labels = labels.to(device)</span><br><span class="line"></span><br><span class="line">                <span class="comment"># zero the parameter gradients</span></span><br><span class="line">                optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line">                outputs = model(inputs)</span><br><span class="line">                <span class="comment"># print(outputs.shape)</span></span><br><span class="line">                _, preds = torch.<span class="built_in">max</span>(outputs, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">                running_corrects += torch.<span class="built_in">sum</span>(preds == labels.data)</span><br><span class="line"></span><br><span class="line">                hard_negative_list, easy_neagtive_list = get_hard_negatives(preds.cpu().numpy(), cache_dicts)</span><br><span class="line">                add_hard_negatives(hard_negative_list, negative_list, add_negative_list)</span><br><span class="line"></span><br><span class="line">            remain_acc = running_corrects.double() / <span class="built_in">len</span>(remain_negative_list)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;remiam negative size: &#123;&#125;, acc: &#123;:.4f&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(remain_negative_list), remain_acc))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 训练完成后，重置负样本，进行hard negatives mining</span></span><br><span class="line">            train_dataset.set_negative_list(negative_list)</span><br><span class="line">            tmp_sampler = CustomBatchSampler(train_dataset.get_positive_num(), train_dataset.get_negative_num(),</span><br><span class="line">                                             batch_positive, batch_negative)</span><br><span class="line">            data_loaders[<span class="string">&#x27;train&#x27;</span>] = DataLoader(train_dataset, batch_size=batch_total, sampler=tmp_sampler,</span><br><span class="line">                                               num_workers=<span class="number">8</span>, drop_last=<span class="literal">True</span>)</span><br><span class="line">            data_loaders[<span class="string">&#x27;add_negative&#x27;</span>] = add_negative_list</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 重置数据集大小</span></span><br><span class="line">            data_sizes[<span class="string">&#x27;train&#x27;</span>] = <span class="built_in">len</span>(tmp_sampler)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 每训练一轮就保存</span></span><br><span class="line">        save_model(model, <span class="string">&#x27;models/linear_svm_alexnet_car_%d.pth&#x27;</span> % epoch)</span><br><span class="line"></span><br><span class="line">    time_elapsed = time.time() - since</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Training complete in &#123;:.0f&#125;m &#123;:.0f&#125;s&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">        time_elapsed // <span class="number">60</span>, time_elapsed % <span class="number">60</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Best val Acc: &#123;:4f&#125;&#x27;</span>.<span class="built_in">format</span>(best_acc))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># load best model weights</span></span><br><span class="line">    model.load_state_dict(best_model_weights)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    device = torch.device(<span class="string">&#x27;cuda:0&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">    <span class="comment"># device = &#x27;cpu&#x27;</span></span><br><span class="line">    data_loaders, data_sizes = load_data(<span class="string">&#x27;./data/classifier_car&#x27;</span>)</span><br><span class="line">    <span class="comment"># 加载CNN模型</span></span><br><span class="line">    model_path = <span class="string">&#x27;./models/alexnet_car.pth&#x27;</span></span><br><span class="line">    model = alexnet()</span><br><span class="line">    num_classes = <span class="number">2</span></span><br><span class="line">    num_features = model.classifier[<span class="number">6</span>].in_features</span><br><span class="line">    model.classifier[<span class="number">6</span>] = nn.Linear(num_features, num_classes)</span><br><span class="line">    model.load_state_dict(torch.load(model_path))</span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    <span class="comment"># 固定特征提取</span></span><br><span class="line">    <span class="keyword">for</span> param <span class="keyword">in</span> model.parameters():</span><br><span class="line">        param.requires_grad = <span class="literal">False</span></span><br><span class="line">    <span class="comment"># 创建SVM分类器</span></span><br><span class="line">    model.classifier[<span class="number">6</span>] = nn.Linear(num_features, num_classes)</span><br><span class="line">    <span class="comment"># print(model)</span></span><br><span class="line">    model = model.to(device)</span><br><span class="line">    criterion = hinge_loss</span><br><span class="line">    <span class="comment"># 由于初始训练集数量很少，所以降低学习率</span></span><br><span class="line">    optimizer = optim.SGD(model.parameters(), lr=<span class="number">1e-4</span>, momentum=<span class="number">0.9</span>)</span><br><span class="line">    <span class="comment"># 共训练25轮，每隔4论减少一次学习率</span></span><br><span class="line">    lr_schduler = optim.lr_scheduler.StepLR(optimizer, step_size=<span class="number">4</span>, gamma=<span class="number">0.1</span>)</span><br><span class="line">    best_model = train_model(data_loaders, model, criterion, optimizer, lr_schduler, num_epochs=<span class="number">25</span>, device=device)</span><br><span class="line">    <span class="comment"># 保存最好的模型参数</span></span><br><span class="line">    save_model(best_model, <span class="string">&#x27;models/best_linear_svm_alexnet_car.pth&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;done&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="selectivesearch-py"><a href="#selectivesearch-py" class="headerlink" title="selectivesearch.py"></a>selectivesearch.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_selective_search</span>():</span><br><span class="line">    gs = cv2.ximgproc.segmentation.createSelectiveSearchSegmentation()</span><br><span class="line">    <span class="keyword">return</span> gs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">config</span>(<span class="params">gs, img, strategy=<span class="string">&#x27;q&#x27;</span></span>):</span><br><span class="line">    gs.setBaseImage(img)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (strategy == <span class="string">&#x27;s&#x27;</span>):</span><br><span class="line">        gs.switchToSingleStrategy()</span><br><span class="line">    <span class="keyword">elif</span> (strategy == <span class="string">&#x27;f&#x27;</span>):</span><br><span class="line">        gs.switchToSelectiveSearchFast()</span><br><span class="line">    <span class="keyword">elif</span> (strategy == <span class="string">&#x27;q&#x27;</span>):</span><br><span class="line">        gs.switchToSelectiveSearchQuality()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(__doc__)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_rects</span>(<span class="params">gs</span>):</span><br><span class="line">    rects = gs.process()</span><br><span class="line">    rects[:, <span class="number">2</span>] += rects[:, <span class="number">0</span>]</span><br><span class="line">    rects[:, <span class="number">3</span>] += rects[:, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rects</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_rect_in_img</span>(<span class="params">img,rects</span>):</span><br><span class="line">    <span class="keyword">for</span> x1,y1,x2,y2 <span class="keyword">in</span> rects[<span class="number">0</span>:<span class="number">1000</span>]:</span><br><span class="line">        cv2.rectangle(img,(x1,y1),(x2,y2),color=(<span class="number">0</span>,<span class="number">0</span>,<span class="number">255</span>),thickness=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    选择性搜索算法操作</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    gs = get_selective_search() <span class="comment">#实例化,生成对象</span></span><br><span class="line">    img = cv2.imread(<span class="string">&#x27;../imgs/456.jpg&#x27;</span>, cv2.IMREAD_COLOR)</span><br><span class="line">    config(gs, img, strategy=<span class="string">&#x27;f&#x27;</span>) <span class="comment">#配置对象</span></span><br><span class="line">    rects = get_rects(gs) <span class="comment">#根据对象取框</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;框的位置坐标：\n&quot;</span>,rects,<span class="string">&quot;\n框的个数:&quot;</span>,<span class="built_in">len</span>(rects))</span><br><span class="line">    get_img = show_rect_in_img(img,rects)</span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;../imgs/777ss.jpg&#x27;</span>,get_img)  <span class="comment">#39-42  and 56-58 lines codes  is a demo to show</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;down&quot;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="utils-x2F"><a href="#utils-x2F" class="headerlink" title="utils&#x2F;"></a>utils&#x2F;</h4><h5 id="data"><a href="#data" class="headerlink" title="data"></a>data</h5><h6 id="create-bbox-regression-data-py"><a href="#create-bbox-regression-data-py" class="headerlink" title="create_bbox_regression_data.py"></a>create_bbox_regression_data.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> utils.util <span class="keyword">as</span> util</span><br><span class="line"></span><br><span class="line"><span class="comment"># 正样本边界框数目：4035</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从voc_car/train目录中提取标注边界框坐标</span></span><br><span class="line"><span class="string">    从finetune_car/train目录中提取训练集正样本坐标（IoU&gt;=0.5），进一步提取IoU&gt;0.6的边界框</span></span><br><span class="line"><span class="string">    数据集保存在bbox_car目录下</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    voc_car_train_dir = <span class="string">&#x27;../../data/voc_car/train&#x27;</span></span><br><span class="line">    <span class="comment"># ground truth</span></span><br><span class="line">    gt_annotation_dir = os.path.join(voc_car_train_dir, <span class="string">&#x27;Annotations&#x27;</span>)</span><br><span class="line">    jpeg_dir = os.path.join(voc_car_train_dir, <span class="string">&#x27;JPEGImages&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    classifier_car_train_dir = <span class="string">&#x27;../../data/finetune_car/train&#x27;</span></span><br><span class="line">    <span class="comment"># positive</span></span><br><span class="line">    positive_annotation_dir = os.path.join(classifier_car_train_dir, <span class="string">&#x27;Annotations&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    dst_root_dir = <span class="string">&#x27;../../data/bbox_regression/&#x27;</span></span><br><span class="line">    dst_jpeg_dir = os.path.join(dst_root_dir, <span class="string">&#x27;JPEGImages&#x27;</span>)</span><br><span class="line">    dst_bndbox_dir = os.path.join(dst_root_dir, <span class="string">&#x27;bndboxs&#x27;</span>)</span><br><span class="line">    dst_positive_dir = os.path.join(dst_root_dir, <span class="string">&#x27;positive&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    util.check_dir(dst_root_dir)</span><br><span class="line">    util.check_dir(dst_jpeg_dir)</span><br><span class="line">    util.check_dir(dst_bndbox_dir)</span><br><span class="line">    util.check_dir(dst_positive_dir)</span><br><span class="line"></span><br><span class="line">    samples = util.parse_car_csv(voc_car_train_dir)</span><br><span class="line">    res_samples = <span class="built_in">list</span>()</span><br><span class="line">    total_positive_num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> sample_name <span class="keyword">in</span> samples:</span><br><span class="line">        <span class="comment"># 提取正样本边界框坐标（IoU&gt;=0.5）</span></span><br><span class="line">        positive_annotation_path = os.path.join(positive_annotation_dir, sample_name + <span class="string">&#x27;_1.csv&#x27;</span>)</span><br><span class="line">        positive_bndboxes = np.loadtxt(positive_annotation_path, dtype=np.<span class="built_in">int</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        <span class="comment"># 提取标注边界框</span></span><br><span class="line">        gt_annotation_path = os.path.join(gt_annotation_dir, sample_name + <span class="string">&#x27;.xml&#x27;</span>)</span><br><span class="line">        bndboxs = util.parse_xml(gt_annotation_path)</span><br><span class="line">        <span class="comment"># 计算符合条件（IoU&gt;0.6）的候选建议</span></span><br><span class="line">        positive_list = <span class="built_in">list</span>()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(positive_bndboxes.shape) == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(positive_bndboxes) != <span class="number">0</span>:</span><br><span class="line">            scores = util.iou(positive_bndboxes, bndboxs)</span><br><span class="line">            <span class="keyword">if</span> np.<span class="built_in">max</span>(scores) &gt; <span class="number">0.6</span>:</span><br><span class="line">                positive_list.append(positive_bndboxes)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(positive_bndboxes.shape) == <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">for</span> positive_bndboxe <span class="keyword">in</span> positive_bndboxes:</span><br><span class="line">                scores = util.iou(positive_bndboxe, bndboxs)</span><br><span class="line">                <span class="keyword">if</span> np.<span class="built_in">max</span>(scores) &gt; <span class="number">0.6</span>:</span><br><span class="line">                    positive_list.append(positive_bndboxe)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果存在正样本边界框（IoU&gt;0.6），那么保存相应的图片以及标注边界框</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(positive_list) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># 保存图片</span></span><br><span class="line">            jpeg_path = os.path.join(jpeg_dir, sample_name + <span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">            dst_jpeg_path = os.path.join(dst_jpeg_dir, sample_name + <span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">            shutil.copyfile(jpeg_path, dst_jpeg_path)</span><br><span class="line">            <span class="comment"># 保存标注边界框</span></span><br><span class="line">            dst_bndbox_path = os.path.join(dst_bndbox_dir, sample_name + <span class="string">&quot;.csv&quot;</span>)</span><br><span class="line">            np.savetxt(dst_bndbox_path, bndboxs, fmt=<span class="string">&#x27;%s&#x27;</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="comment"># 保存正样本边界框</span></span><br><span class="line">            dst_positive_path = os.path.join(dst_positive_dir, sample_name + <span class="string">&quot;.csv&quot;</span>)</span><br><span class="line">            np.savetxt(dst_positive_path, np.array(positive_list), fmt=<span class="string">&#x27;%s&#x27;</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">            total_positive_num += <span class="built_in">len</span>(positive_list)</span><br><span class="line">            res_samples.append(sample_name)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;save &#123;&#125; done&#x27;</span>.<span class="built_in">format</span>(sample_name))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;-------- &#123;&#125; 不符合条件&#x27;</span>.<span class="built_in">format</span>(sample_name))</span><br><span class="line"></span><br><span class="line">    dst_csv_path = os.path.join(dst_root_dir, <span class="string">&#x27;car.csv&#x27;</span>)</span><br><span class="line">    np.savetxt(dst_csv_path, res_samples, fmt=<span class="string">&#x27;%s&#x27;</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;total positive num: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(total_positive_num))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;done&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="create-classifier-data-py"><a href="#create-classifier-data-py" class="headerlink" title="create_classifier_data.py"></a>create_classifier_data.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> xmltodict</span><br><span class="line"><span class="keyword">import</span> selectivesearch</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> check_dir</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> parse_car_csv</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> parse_xml</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> iou</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> compute_ious</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># train</span></span><br><span class="line"><span class="comment"># positive num: 67</span></span><br><span class="line"><span class="comment"># negative num: 34674</span></span><br><span class="line"><span class="comment"># val</span></span><br><span class="line"><span class="comment"># positive num: 75</span></span><br><span class="line"><span class="comment"># negative num: 26277</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_annotation_jpeg</span>(<span class="params">annotation_path, jpeg_path, gs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取正负样本（注：忽略属性difficult为True的标注边界框）</span></span><br><span class="line"><span class="string">    正样本：标注边界框</span></span><br><span class="line"><span class="string">    负样本：IoU大于0，小于等于0.3。为了进一步限制负样本数目，其大小必须大于最大标注框的1/5</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    img = cv2.imread(jpeg_path)</span><br><span class="line"></span><br><span class="line">    selectivesearch.config(gs, img, strategy=<span class="string">&#x27;q&#x27;</span>)</span><br><span class="line">    <span class="comment"># 计算候选建议</span></span><br><span class="line">    rects = selectivesearch.get_rects(gs)</span><br><span class="line">    <span class="comment"># 获取标注边界框</span></span><br><span class="line">    bndboxs = parse_xml(annotation_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 标注框大小</span></span><br><span class="line">    maximum_bndbox_size = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> bndbox <span class="keyword">in</span> bndboxs:</span><br><span class="line">        xmin, ymin, xmax, ymax = bndbox</span><br><span class="line">        bndbox_size = (ymax - ymin) * (xmax - xmin)</span><br><span class="line">        <span class="keyword">if</span> bndbox_size &gt; maximum_bndbox_size:</span><br><span class="line">            maximum_bndbox_size = bndbox_size</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取候选建议和标注边界框的IoU</span></span><br><span class="line">    iou_list = compute_ious(rects, bndboxs)</span><br><span class="line"></span><br><span class="line">    positive_list = <span class="built_in">list</span>()</span><br><span class="line">    negative_list = <span class="built_in">list</span>()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(iou_list)):</span><br><span class="line">        xmin, ymin, xmax, ymax = rects[i]</span><br><span class="line">        rect_size = (ymax - ymin) * (xmax - xmin)</span><br><span class="line"></span><br><span class="line">        iou_score = iou_list[i]</span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt; iou_score &lt;= <span class="number">0.3</span> <span class="keyword">and</span> rect_size &gt; maximum_bndbox_size / <span class="number">5.0</span>:</span><br><span class="line">            <span class="comment"># 负样本</span></span><br><span class="line">            negative_list.append(rects[i])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bndboxs, negative_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    car_root_dir = <span class="string">&#x27;../../data/voc_car/&#x27;</span></span><br><span class="line">    classifier_root_dir = <span class="string">&#x27;../../data/classifier_car/&#x27;</span></span><br><span class="line">    check_dir(classifier_root_dir)</span><br><span class="line"></span><br><span class="line">    gs = selectivesearch.get_selective_search()  <span class="comment"># 实例化,生成ｇｓ对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> [<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;val&#x27;</span>]:</span><br><span class="line">        src_root_dir = os.path.join(car_root_dir, name)</span><br><span class="line">        src_annotation_dir = os.path.join(src_root_dir, <span class="string">&#x27;Annotations&#x27;</span>)</span><br><span class="line">        src_jpeg_dir = os.path.join(src_root_dir, <span class="string">&#x27;JPEGImages&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        dst_root_dir = os.path.join(classifier_root_dir, name)</span><br><span class="line">        dst_annotation_dir = os.path.join(dst_root_dir, <span class="string">&#x27;Annotations&#x27;</span>)</span><br><span class="line">        dst_jpeg_dir = os.path.join(dst_root_dir, <span class="string">&#x27;JPEGImages&#x27;</span>)</span><br><span class="line">        check_dir(dst_root_dir)</span><br><span class="line">        check_dir(dst_annotation_dir)</span><br><span class="line">        check_dir(dst_jpeg_dir)</span><br><span class="line"></span><br><span class="line">        total_num_positive = <span class="number">0</span></span><br><span class="line">        total_num_negative = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        samples = parse_car_csv(src_root_dir)  <span class="comment"># 在src_root_dir目录下加载ｃｓｖ文件</span></span><br><span class="line">        <span class="comment"># 复制csv文件</span></span><br><span class="line">        src_csv_path = os.path.join(src_root_dir, <span class="string">&#x27;car.csv&#x27;</span>)</span><br><span class="line">        dst_csv_path = os.path.join(dst_root_dir, <span class="string">&#x27;car.csv&#x27;</span>)</span><br><span class="line">        shutil.copyfile(src_csv_path, dst_csv_path)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> sample_name <span class="keyword">in</span> samples:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                since = time.time()</span><br><span class="line"></span><br><span class="line">                src_annotation_path = os.path.join(src_annotation_dir, sample_name + <span class="string">&#x27;.xml&#x27;</span>)</span><br><span class="line">                src_jpeg_path = os.path.join(src_jpeg_dir, sample_name + <span class="string">&#x27;.jpg&#x27;</span>)</span><br><span class="line">                <span class="comment"># 获取正负样本</span></span><br><span class="line">                positive_list, negative_list = parse_annotation_jpeg(src_annotation_path, src_jpeg_path, gs)</span><br><span class="line">                total_num_positive += <span class="built_in">len</span>(positive_list)</span><br><span class="line">                total_num_negative += <span class="built_in">len</span>(negative_list)</span><br><span class="line"></span><br><span class="line">                dst_annotation_positive_path = os.path.join(dst_annotation_dir, sample_name + <span class="string">&#x27;_1&#x27;</span> + <span class="string">&#x27;.csv&#x27;</span>)</span><br><span class="line">                dst_annotation_negative_path = os.path.join(dst_annotation_dir, sample_name + <span class="string">&#x27;_0&#x27;</span> + <span class="string">&#x27;.csv&#x27;</span>)</span><br><span class="line">                dst_jpeg_path = os.path.join(dst_jpeg_dir, sample_name + <span class="string">&#x27;.jpg&#x27;</span>)</span><br><span class="line">                <span class="comment"># 保存图片</span></span><br><span class="line">                shutil.copyfile(src_jpeg_path, dst_jpeg_path)</span><br><span class="line">                <span class="comment"># 保存正负样本标注</span></span><br><span class="line">                np.savetxt(dst_annotation_positive_path, np.array(positive_list), fmt=<span class="string">&#x27;%d&#x27;</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                np.savetxt(dst_annotation_negative_path, np.array(negative_list), fmt=<span class="string">&#x27;%d&#x27;</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">                time_elapsed = time.time() - since</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;parse &#123;&#125;.png in &#123;:.0f&#125;m &#123;:.0f&#125;s&#x27;</span>.<span class="built_in">format</span>(sample_name, time_elapsed // <span class="number">60</span>, time_elapsed % <span class="number">60</span>))</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">                <span class="built_in">print</span>(err)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s positive num: %d&#x27;</span> % (name, total_num_positive))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s negative num: %d&#x27;</span> % (name, total_num_negative))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;done&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="create-finetune-data-py"><a href="#create-finetune-data-py" class="headerlink" title="create_finetune_data.py"></a>create_finetune_data.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> selectivesearch</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> check_dir</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> parse_car_csv</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> parse_xml</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> compute_ious</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># train</span></span><br><span class="line"><span class="comment"># positive num: 7278　　这是对数据集进行下采样缩到原数据集的10%得到的数据</span></span><br><span class="line"><span class="comment"># negative num: 44706</span></span><br><span class="line"><span class="comment"># val</span></span><br><span class="line"><span class="comment"># positive num: 7951</span></span><br><span class="line"><span class="comment"># negative num: 36277</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_annotation_jpeg</span>(<span class="params">annotation_path, jpeg_path, gs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取正负样本（注：忽略属性difficult为True的标注边界框）</span></span><br><span class="line"><span class="string">    正样本：候选建议与标注边界框IoU大于等于0.5</span></span><br><span class="line"><span class="string">    负样本：IoU大于0,小于0.5。为了进一步限制负样本数目，其大小必须大于标注框的1/5</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    img = cv2.imread(jpeg_path)</span><br><span class="line"></span><br><span class="line">    selectivesearch.config(gs, img, strategy=<span class="string">&#x27;q&#x27;</span>)</span><br><span class="line">    <span class="comment"># 计算候选建议</span></span><br><span class="line">    rects = selectivesearch.get_rects(gs)</span><br><span class="line">    <span class="comment"># 获取标注边界框</span></span><br><span class="line">    bndboxs = parse_xml(annotation_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 标注框大小</span></span><br><span class="line">    maximum_bndbox_size = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> bndbox <span class="keyword">in</span> bndboxs:</span><br><span class="line">        xmin, ymin, xmax, ymax = bndbox</span><br><span class="line">        bndbox_size = (ymax - ymin) * (xmax - xmin)</span><br><span class="line">        <span class="keyword">if</span> bndbox_size &gt; maximum_bndbox_size:</span><br><span class="line">            maximum_bndbox_size = bndbox_size</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取候选建议和标注边界框的IoU</span></span><br><span class="line">    iou_list = compute_ious(rects, bndboxs)</span><br><span class="line"></span><br><span class="line">    positive_list = <span class="built_in">list</span>()</span><br><span class="line">    negative_list = <span class="built_in">list</span>()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(iou_list)):</span><br><span class="line">        xmin, ymin, xmax, ymax = rects[i]</span><br><span class="line">        rect_size = (ymax - ymin) * (xmax - xmin)</span><br><span class="line"></span><br><span class="line">        iou_score = iou_list[i]</span><br><span class="line">        <span class="keyword">if</span> iou_list[i] &gt;= <span class="number">0.5</span>:</span><br><span class="line">            <span class="comment"># 正样本</span></span><br><span class="line">            positive_list.append(rects[i])</span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt; iou_list[i] &lt; <span class="number">0.5</span> <span class="keyword">and</span> rect_size &gt; maximum_bndbox_size / <span class="number">5.0</span>:</span><br><span class="line">            <span class="comment"># 负样本</span></span><br><span class="line">            negative_list.append(rects[i])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> positive_list, negative_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    car_root_dir = <span class="string">&#x27;../../data/voc_car/&#x27;</span></span><br><span class="line">    finetune_root_dir = <span class="string">&#x27;../../data/finetune_car/&#x27;</span></span><br><span class="line">    check_dir(finetune_root_dir)</span><br><span class="line"></span><br><span class="line">    gs = selectivesearch.get_selective_search()</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> [<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;val&#x27;</span>]:</span><br><span class="line">        src_root_dir = os.path.join(car_root_dir, name)</span><br><span class="line">        src_annotation_dir = os.path.join(src_root_dir, <span class="string">&#x27;Annotations&#x27;</span>)</span><br><span class="line">        src_jpeg_dir = os.path.join(src_root_dir, <span class="string">&#x27;JPEGImages&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        dst_root_dir = os.path.join(finetune_root_dir, name)</span><br><span class="line">        dst_annotation_dir = os.path.join(dst_root_dir, <span class="string">&#x27;Annotations&#x27;</span>)</span><br><span class="line">        dst_jpeg_dir = os.path.join(dst_root_dir, <span class="string">&#x27;JPEGImages&#x27;</span>)</span><br><span class="line">        check_dir(dst_root_dir)</span><br><span class="line">        check_dir(dst_annotation_dir)</span><br><span class="line">        check_dir(dst_jpeg_dir)</span><br><span class="line"></span><br><span class="line">        total_num_positive = <span class="number">0</span></span><br><span class="line">        total_num_negative = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        samples = parse_car_csv(src_root_dir)  <span class="comment"># 拿到根目录下的csv 文件</span></span><br><span class="line">        <span class="comment"># 复制csv文件</span></span><br><span class="line">        src_csv_path = os.path.join(src_root_dir, <span class="string">&#x27;car.csv&#x27;</span>)</span><br><span class="line">        dst_csv_path = os.path.join(dst_root_dir, <span class="string">&#x27;car.csv&#x27;</span>)</span><br><span class="line">        shutil.copyfile(src_csv_path, dst_csv_path)</span><br><span class="line">        <span class="keyword">for</span> sample_name <span class="keyword">in</span> samples:</span><br><span class="line">            since = time.time()</span><br><span class="line"></span><br><span class="line">            src_annotation_path = os.path.join(src_annotation_dir, sample_name + <span class="string">&#x27;.xml&#x27;</span>)</span><br><span class="line">            src_jpeg_path = os.path.join(src_jpeg_dir, sample_name + <span class="string">&#x27;.jpg&#x27;</span>)</span><br><span class="line">            <span class="comment"># 获取正负样本</span></span><br><span class="line">            positive_list, negative_list = parse_annotation_jpeg(src_annotation_path, src_jpeg_path, gs)</span><br><span class="line">            total_num_positive += <span class="built_in">len</span>(positive_list)</span><br><span class="line">            total_num_negative += <span class="built_in">len</span>(negative_list)</span><br><span class="line"></span><br><span class="line">            dst_annotation_positive_path = os.path.join(dst_annotation_dir, sample_name + <span class="string">&#x27;_1&#x27;</span> + <span class="string">&#x27;.csv&#x27;</span>)</span><br><span class="line">            dst_annotation_negative_path = os.path.join(dst_annotation_dir, sample_name + <span class="string">&#x27;_0&#x27;</span> + <span class="string">&#x27;.csv&#x27;</span>)</span><br><span class="line">            dst_jpeg_path = os.path.join(dst_jpeg_dir, sample_name + <span class="string">&#x27;.jpg&#x27;</span>)</span><br><span class="line">            <span class="comment"># 保存图片</span></span><br><span class="line">            shutil.copyfile(src_jpeg_path, dst_jpeg_path)</span><br><span class="line">            <span class="comment"># 保存正负样本标注</span></span><br><span class="line">            np.savetxt(dst_annotation_positive_path, np.array(positive_list), fmt=<span class="string">&#x27;%d&#x27;</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            np.savetxt(dst_annotation_negative_path, np.array(negative_list), fmt=<span class="string">&#x27;%d&#x27;</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">            time_elapsed = time.time() - since</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;parse &#123;&#125;.png in &#123;:.0f&#125;m &#123;:.0f&#125;s&#x27;</span>.<span class="built_in">format</span>(sample_name, time_elapsed // <span class="number">60</span>, time_elapsed % <span class="number">60</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s positive num: %d&#x27;</span> % (name, total_num_positive))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s negative num: %d&#x27;</span> % (name, total_num_negative))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;done&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h6 id="custom-batch-sampler-py"><a href="#custom-batch-sampler-py" class="headerlink" title="custom_batch_sampler.py"></a>custom_batch_sampler.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy  <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Sampler</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">from</span> utils.data.custom_finetune_dataset <span class="keyword">import</span> CustomFinetuneDataset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomBatchSampler</span>(<span class="title class_ inherited__">Sampler</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_positive, num_negative, batch_positive, batch_negative</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        2分类数据集</span></span><br><span class="line"><span class="string">        每次批量处理，其中batch_positive个正样本，batch_negative个负样本</span></span><br><span class="line"><span class="string">        @param num_positive: 正样本数目</span></span><br><span class="line"><span class="string">        @param num_negative: 负样本数目</span></span><br><span class="line"><span class="string">        @param batch_positive: 单次正样本数</span></span><br><span class="line"><span class="string">        @param batch_negative: 单次负样本数</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.num_positive = num_positive</span><br><span class="line">        self.num_negative = num_negative</span><br><span class="line">        self.batch_positive = batch_positive</span><br><span class="line">        self.batch_negative = batch_negative</span><br><span class="line"></span><br><span class="line">        length = num_positive + num_negative</span><br><span class="line">        self.idx_list = <span class="built_in">list</span>(<span class="built_in">range</span>(length))</span><br><span class="line"></span><br><span class="line">        self.batch = batch_negative + batch_positive</span><br><span class="line">        self.num_iter = length // self.batch</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        sampler_list = <span class="built_in">list</span>()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.num_iter):</span><br><span class="line">            tmp = np.concatenate(</span><br><span class="line">                (random.sample(self.idx_list[:self.num_positive], self.batch_positive),</span><br><span class="line">                 random.sample(self.idx_list[self.num_positive:], self.batch_negative))</span><br><span class="line">            )</span><br><span class="line">            random.shuffle(tmp)</span><br><span class="line">            sampler_list.extend(tmp)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">iter</span>(sampler_list)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> self.num_iter * self.batch</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_num_batch</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> self.num_iter</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="custom-bbox-regression-dataset-py"><a href="#custom-bbox-regression-dataset-py" class="headerlink" title="custom_bbox_regression_dataset.py"></a>custom_bbox_regression_dataset.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> utils.util <span class="keyword">as</span> util</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BBoxRegressionDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, root_dir, transform=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(BBoxRegressionDataset, self).__init__()</span><br><span class="line">        self.transform = transform</span><br><span class="line"></span><br><span class="line">        samples = util.parse_car_csv(root_dir)</span><br><span class="line">        jpeg_list = <span class="built_in">list</span>()</span><br><span class="line">        <span class="comment"># 保存&#123;&#x27;image_id&#x27;: ?, &#x27;positive&#x27;: ?, &#x27;bndbox&#x27;: ?&#125;</span></span><br><span class="line">        box_list = <span class="built_in">list</span>()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(samples)):</span><br><span class="line">            sample_name = samples[i]</span><br><span class="line"></span><br><span class="line">            jpeg_path = os.path.join(root_dir, <span class="string">&#x27;JPEGImages&#x27;</span>, sample_name + <span class="string">&#x27;.jpg&#x27;</span>)</span><br><span class="line">            bndbox_path = os.path.join(root_dir, <span class="string">&#x27;bndboxs&#x27;</span>, sample_name + <span class="string">&#x27;.csv&#x27;</span>)</span><br><span class="line">            positive_path = os.path.join(root_dir, <span class="string">&#x27;positive&#x27;</span>, sample_name + <span class="string">&#x27;.csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            jpeg_list.append(cv2.imread(jpeg_path))</span><br><span class="line">            bndboxes = np.loadtxt(bndbox_path, dtype=np.<span class="built_in">int</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            positives = np.loadtxt(positive_path, dtype=np.<span class="built_in">int</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(positives.shape) == <span class="number">1</span>:</span><br><span class="line">                bndbox = self.get_bndbox(bndboxes, positives)</span><br><span class="line">                box_list.append(&#123;<span class="string">&#x27;image_id&#x27;</span>: i, <span class="string">&#x27;positive&#x27;</span>: positives, <span class="string">&#x27;bndbox&#x27;</span>: bndbox&#125;)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">for</span> positive <span class="keyword">in</span> positives:</span><br><span class="line">                    bndbox = self.get_bndbox(bndboxes, positive)</span><br><span class="line">                    box_list.append(&#123;<span class="string">&#x27;image_id&#x27;</span>: i, <span class="string">&#x27;positive&#x27;</span>: positive, <span class="string">&#x27;bndbox&#x27;</span>: bndbox&#125;)</span><br><span class="line"></span><br><span class="line">        self.jpeg_list = jpeg_list</span><br><span class="line">        self.box_list = box_list</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="keyword">assert</span> index &lt; self.__len__(), <span class="string">&#x27;数据集大小为%d，当前输入下标为%d&#x27;</span> % (self.__len__(), index)</span><br><span class="line"></span><br><span class="line">        box_dict = self.box_list[index]</span><br><span class="line">        image_id = box_dict[<span class="string">&#x27;image_id&#x27;</span>]</span><br><span class="line">        positive = box_dict[<span class="string">&#x27;positive&#x27;</span>]</span><br><span class="line">        bndbox = box_dict[<span class="string">&#x27;bndbox&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取预测图像</span></span><br><span class="line">        jpeg_img = self.jpeg_list[image_id]</span><br><span class="line">        xmin, ymin, xmax, ymax = positive</span><br><span class="line">        image = jpeg_img[ymin:ymax, xmin:xmax]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.transform:</span><br><span class="line">            image = self.transform(image)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算P/G的x/y/w/h</span></span><br><span class="line">        target = <span class="built_in">dict</span>()</span><br><span class="line">        p_w = xmax - xmin</span><br><span class="line">        p_h = ymax - ymin</span><br><span class="line">        p_x = xmin + p_w / <span class="number">2</span></span><br><span class="line">        p_y = ymin + p_h / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        xmin, ymin, xmax, ymax = bndbox</span><br><span class="line">        g_w = xmax - xmin</span><br><span class="line">        g_h = ymax - ymin</span><br><span class="line">        g_x = xmin + g_w / <span class="number">2</span></span><br><span class="line">        g_y = ymin + g_h / <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 计算t</span></span><br><span class="line">        t_x = (g_x - p_x) / p_w</span><br><span class="line">        t_y = (g_y - p_y) / p_h</span><br><span class="line">        t_w = np.log(g_w / p_w)</span><br><span class="line">        t_h = np.log(g_h / p_h)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> image, np.array((t_x, t_y, t_w, t_h))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.box_list)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_bndbox</span>(<span class="params">self, bndboxes, positive</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        返回和positive的IoU最大的标注边界框</span></span><br><span class="line"><span class="string">        :param bndboxes: 大小为[N, 4]或者[4]</span></span><br><span class="line"><span class="string">        :param positive: 大小为[4]</span></span><br><span class="line"><span class="string">        :return: [4]</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(bndboxes.shape) == <span class="number">1</span>:</span><br><span class="line">            <span class="comment"># 只有一个标注边界框，直接返回即可</span></span><br><span class="line">            <span class="keyword">return</span> bndboxes</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            scores = util.iou(positive, bndboxes)</span><br><span class="line">            <span class="keyword">return</span> bndboxes[np.argmax(scores)]</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="custom-classifier-dataset-py"><a href="#custom-classifier-dataset-py" class="headerlink" title="custom_classifier_dataset.py"></a>custom_classifier_dataset.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy  <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> parse_car_csv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomClassifierDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, root_dir, transform=<span class="literal">None</span></span>):</span><br><span class="line">        samples = parse_car_csv(root_dir)</span><br><span class="line"></span><br><span class="line">        jpeg_images = <span class="built_in">list</span>()</span><br><span class="line">        positive_list = <span class="built_in">list</span>()</span><br><span class="line">        negative_list = <span class="built_in">list</span>()</span><br><span class="line">        <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(samples)):</span><br><span class="line">            sample_name = samples[idx]</span><br><span class="line">            jpeg_images.append(cv2.imread(os.path.join(root_dir, <span class="string">&#x27;JPEGImages&#x27;</span>, sample_name + <span class="string">&quot;.jpg&quot;</span>)))</span><br><span class="line"></span><br><span class="line">            positive_annotation_path = os.path.join(root_dir, <span class="string">&#x27;Annotations&#x27;</span>, sample_name + <span class="string">&#x27;_1.csv&#x27;</span>)</span><br><span class="line">            positive_annotations = np.loadtxt(positive_annotation_path, dtype=np.<span class="built_in">int</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="comment"># 考虑csv文件为空或者仅包含单个标注框</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(positive_annotations.shape) == <span class="number">1</span>:</span><br><span class="line">                <span class="comment"># 单个标注框坐标</span></span><br><span class="line">                <span class="keyword">if</span> positive_annotations.shape[<span class="number">0</span>] == <span class="number">4</span>:</span><br><span class="line">                    positive_dict = <span class="built_in">dict</span>()</span><br><span class="line"></span><br><span class="line">                    positive_dict[<span class="string">&#x27;rect&#x27;</span>] = positive_annotations</span><br><span class="line">                    positive_dict[<span class="string">&#x27;image_id&#x27;</span>] = idx</span><br><span class="line">                    <span class="comment"># positive_dict[&#x27;image_name&#x27;] = sample_name</span></span><br><span class="line"></span><br><span class="line">                    positive_list.append(positive_dict)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">for</span> positive_annotation <span class="keyword">in</span> positive_annotations:</span><br><span class="line">                    positive_dict = <span class="built_in">dict</span>()</span><br><span class="line"></span><br><span class="line">                    positive_dict[<span class="string">&#x27;rect&#x27;</span>] = positive_annotation</span><br><span class="line">                    positive_dict[<span class="string">&#x27;image_id&#x27;</span>] = idx</span><br><span class="line">                    <span class="comment"># positive_dict[&#x27;image_name&#x27;] = sample_name</span></span><br><span class="line"></span><br><span class="line">                    positive_list.append(positive_dict)</span><br><span class="line"></span><br><span class="line">            negative_annotation_path = os.path.join(root_dir, <span class="string">&#x27;Annotations&#x27;</span>, sample_name + <span class="string">&#x27;_0.csv&#x27;</span>)</span><br><span class="line">            negative_annotations = np.loadtxt(negative_annotation_path, dtype=np.<span class="built_in">int</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="comment"># 考虑csv文件为空或者仅包含单个标注框</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(negative_annotations.shape) == <span class="number">1</span>:</span><br><span class="line">                <span class="comment"># 单个标注框坐标</span></span><br><span class="line">                <span class="keyword">if</span> negative_annotations.shape[<span class="number">0</span>] == <span class="number">4</span>:</span><br><span class="line">                    negative_dict = <span class="built_in">dict</span>()</span><br><span class="line"></span><br><span class="line">                    negative_dict[<span class="string">&#x27;rect&#x27;</span>] = negative_annotations</span><br><span class="line">                    negative_dict[<span class="string">&#x27;image_id&#x27;</span>] = idx</span><br><span class="line">                    <span class="comment"># negative_dict[&#x27;image_name&#x27;] = sample_name</span></span><br><span class="line"></span><br><span class="line">                    negative_list.append(negative_dict)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">for</span> negative_annotation <span class="keyword">in</span> negative_annotations:</span><br><span class="line">                    negative_dict = <span class="built_in">dict</span>()</span><br><span class="line"></span><br><span class="line">                    negative_dict[<span class="string">&#x27;rect&#x27;</span>] = negative_annotation</span><br><span class="line">                    negative_dict[<span class="string">&#x27;image_id&#x27;</span>] = idx</span><br><span class="line">                    <span class="comment"># negative_dict[&#x27;image_name&#x27;] = sample_name</span></span><br><span class="line"></span><br><span class="line">                    negative_list.append(negative_dict)</span><br><span class="line"></span><br><span class="line">        self.transform = transform</span><br><span class="line">        self.jpeg_images = jpeg_images</span><br><span class="line">        self.positive_list = positive_list</span><br><span class="line">        self.negative_list = negative_list</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="comment"># 定位下标所属图像</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; <span class="built_in">len</span>(self.positive_list):</span><br><span class="line">            <span class="comment"># 正样本</span></span><br><span class="line">            target = <span class="number">1</span></span><br><span class="line">            positive_dict = self.positive_list[index]</span><br><span class="line"></span><br><span class="line">            xmin, ymin, xmax, ymax = positive_dict[<span class="string">&#x27;rect&#x27;</span>]</span><br><span class="line">            image_id = positive_dict[<span class="string">&#x27;image_id&#x27;</span>]</span><br><span class="line"></span><br><span class="line">            image = self.jpeg_images[image_id][ymin:ymax, xmin:xmax]</span><br><span class="line">            cache_dict = positive_dict</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 负样本</span></span><br><span class="line">            target = <span class="number">0</span></span><br><span class="line">            idx = index - <span class="built_in">len</span>(self.positive_list)</span><br><span class="line">            negative_dict = self.negative_list[idx]</span><br><span class="line"></span><br><span class="line">            xmin, ymin, xmax, ymax = negative_dict[<span class="string">&#x27;rect&#x27;</span>]</span><br><span class="line">            image_id = negative_dict[<span class="string">&#x27;image_id&#x27;</span>]</span><br><span class="line"></span><br><span class="line">            image = self.jpeg_images[image_id][ymin:ymax, xmin:xmax]</span><br><span class="line">            cache_dict = negative_dict</span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(&#x27;index: %d image_id: %d target: %d image.shape: %s [xmin, ymin, xmax, ymax]: [%d, %d, %d, %d]&#x27; %</span></span><br><span class="line">        <span class="comment">#       (index, image_id, target, str(image.shape), xmin, ymin, xmax, ymax))</span></span><br><span class="line">        <span class="keyword">if</span> self.transform:</span><br><span class="line">            image = self.transform(image)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> image, target, cache_dict</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.positive_list) + <span class="built_in">len</span>(self.negative_list)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_transform</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.transform</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_jpeg_images</span>(<span class="params">self</span>) -&gt; <span class="built_in">list</span>:</span><br><span class="line">        <span class="keyword">return</span> self.jpeg_images</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_positive_num</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.positive_list)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_negative_num</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.negative_list)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_positives</span>(<span class="params">self</span>) -&gt; <span class="built_in">list</span>:</span><br><span class="line">        <span class="keyword">return</span> self.positive_list</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_negatives</span>(<span class="params">self</span>) -&gt; <span class="built_in">list</span>:</span><br><span class="line">        <span class="keyword">return</span> self.negative_list</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用于hard negative mining</span></span><br><span class="line">    <span class="comment"># 替换负样本</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_negative_list</span>(<span class="params">self, negative_list</span>):</span><br><span class="line">        self.negative_list = negative_list</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="custom-finetune-dataset-py"><a href="#custom-finetune-dataset-py" class="headerlink" title="custom_finetune_dataset.py"></a>custom_finetune_dataset.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy  <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">import</span> torchvision.transforms <span class="keyword">as</span> transforms</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> parse_car_csv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomFinetuneDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, root_dir, transform=<span class="literal">None</span></span>):</span><br><span class="line">        samples = parse_car_csv(root_dir)</span><br><span class="line"></span><br><span class="line">        jpeg_images = [cv2.imread(os.path.join(root_dir, <span class="string">&#x27;JPEGImages&#x27;</span>, sample_name + <span class="string">&quot;.jpg&quot;</span>))</span><br><span class="line">                       <span class="keyword">for</span> sample_name <span class="keyword">in</span> samples]</span><br><span class="line"></span><br><span class="line">        positive_annotations = [os.path.join(root_dir, <span class="string">&#x27;Annotations&#x27;</span>, sample_name + <span class="string">&#x27;_1.csv&#x27;</span>)</span><br><span class="line">                                <span class="keyword">for</span> sample_name <span class="keyword">in</span> samples]</span><br><span class="line">        negative_annotations = [os.path.join(root_dir, <span class="string">&#x27;Annotations&#x27;</span>, sample_name + <span class="string">&#x27;_0.csv&#x27;</span>)</span><br><span class="line">                                <span class="keyword">for</span> sample_name <span class="keyword">in</span> samples]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 边界　　计数</span></span><br><span class="line">        positive_sizes = <span class="built_in">list</span>()</span><br><span class="line">        negative_sizes = <span class="built_in">list</span>()</span><br><span class="line">        <span class="comment"># 边界框坐标,抽取出 边界值放到 下面的列表里面</span></span><br><span class="line">        positive_rects = <span class="built_in">list</span>()</span><br><span class="line">        negative_rects = <span class="built_in">list</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> annotation_path <span class="keyword">in</span> positive_annotations:</span><br><span class="line">            rects = np.loadtxt(annotation_path, dtype=np.<span class="built_in">int</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="comment"># 存在文件为空或者文件中仅有单行数据</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(rects.shape) == <span class="number">1</span>:</span><br><span class="line">                <span class="comment"># 是否为单行</span></span><br><span class="line">                <span class="keyword">if</span> rects.shape[<span class="number">0</span>] == <span class="number">4</span>:</span><br><span class="line">                    positive_rects.append(rects)</span><br><span class="line">                    positive_sizes.append(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    positive_sizes.append(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                positive_rects.extend(rects)</span><br><span class="line">                positive_sizes.append(<span class="built_in">len</span>(rects))</span><br><span class="line">        <span class="keyword">for</span> annotation_path <span class="keyword">in</span> negative_annotations:</span><br><span class="line">            rects = np.loadtxt(annotation_path, dtype=np.<span class="built_in">int</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="comment"># 和正样本规则一样</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(rects.shape) == <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> rects.shape[<span class="number">0</span>] == <span class="number">4</span>:</span><br><span class="line">                    negative_rects.append(rects)</span><br><span class="line">                    negative_sizes.append(<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    positive_sizes.append(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                negative_rects.extend(rects)</span><br><span class="line">                negative_sizes.append(<span class="built_in">len</span>(rects))</span><br><span class="line"></span><br><span class="line">        self.transform = transform</span><br><span class="line">        self.jpeg_images = jpeg_images</span><br><span class="line">        self.positive_sizes = positive_sizes</span><br><span class="line">        self.negative_sizes = negative_sizes</span><br><span class="line">        self.positive_rects = positive_rects</span><br><span class="line">        self.negative_rects = negative_rects</span><br><span class="line">        self.total_positive_num = <span class="built_in">int</span>(np.<span class="built_in">sum</span>(positive_sizes))</span><br><span class="line">        self.total_negative_num = <span class="built_in">int</span>(np.<span class="built_in">sum</span>(negative_sizes))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="comment"># 定位下标所属图像</span></span><br><span class="line">        image_id = <span class="built_in">len</span>(self.jpeg_images) - <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> index &lt; self.total_positive_num:</span><br><span class="line">            <span class="comment"># 正样本</span></span><br><span class="line">            target = <span class="number">1</span></span><br><span class="line">            xmin, ymin, xmax, ymax = self.positive_rects[index]</span><br><span class="line">            <span class="comment"># 寻找所属图像</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.positive_sizes) - <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> np.<span class="built_in">sum</span>(self.positive_sizes[:i]) &lt;= index &lt; np.<span class="built_in">sum</span>(self.positive_sizes[:(i + <span class="number">1</span>)]):</span><br><span class="line">                    image_id = i</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            image = self.jpeg_images[image_id][ymin:ymax, xmin:xmax]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 负样本</span></span><br><span class="line">            target = <span class="number">0</span></span><br><span class="line">            idx = index - self.total_positive_num</span><br><span class="line">            xmin, ymin, xmax, ymax = self.negative_rects[idx]</span><br><span class="line">            <span class="comment"># 寻找所属图像</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.negative_sizes) - <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> np.<span class="built_in">sum</span>(self.negative_sizes[:i]) &lt;= idx &lt; np.<span class="built_in">sum</span>(self.negative_sizes[:(i + <span class="number">1</span>)]):</span><br><span class="line">                    image_id = i</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            image = self.jpeg_images[image_id][ymin:ymax, xmin:xmax]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(&#x27;index: %d image_id: %d target: %d image.shape: %s [xmin, ymin, xmax, ymax]: [%d, %d, %d, %d]&#x27; %</span></span><br><span class="line">        <span class="comment">#       (index, image_id, target, str(image.shape), xmin, ymin, xmax, ymax))</span></span><br><span class="line">        <span class="keyword">if</span> self.transform:</span><br><span class="line">            image = self.transform(image)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> image, target</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> self.total_positive_num + self.total_negative_num</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_positive_num</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> self.total_positive_num</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_negative_num</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> self.total_negative_num</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="custom-hard-negative-mining-dataset-py"><a href="#custom-hard-negative-mining-dataset-py" class="headerlink" title="custom_hard_negative_mining_dataset.py"></a>custom_hard_negative_mining_dataset.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset</span><br><span class="line"><span class="keyword">from</span> utils.data.custom_classifier_dataset <span class="keyword">import</span> CustomClassifierDataset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomHardNegativeMiningDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, negative_list, jpeg_images, transform=<span class="literal">None</span></span>):</span><br><span class="line">        self.negative_list = negative_list</span><br><span class="line">        self.jpeg_images = jpeg_images</span><br><span class="line">        self.transform = transform</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, index: <span class="built_in">int</span></span>):</span><br><span class="line">        target = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        negative_dict = self.negative_list[index]</span><br><span class="line">        xmin, ymin, xmax, ymax = negative_dict[<span class="string">&#x27;rect&#x27;</span>]</span><br><span class="line">        image_id = negative_dict[<span class="string">&#x27;image_id&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        image = self.jpeg_images[image_id][ymin:ymax, xmin:xmax]</span><br><span class="line">        <span class="keyword">if</span> self.transform:</span><br><span class="line">            image = self.transform(image)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> image, target, negative_dict</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.negative_list)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    root_dir = <span class="string">&#x27;../../data/classifier_car/train&#x27;</span></span><br><span class="line">    data_set = CustomClassifierDataset(root_dir)</span><br><span class="line"></span><br><span class="line">    negative_list = data_set.get_negatives()</span><br><span class="line">    jpeg_images = data_set.get_jpeg_images()</span><br><span class="line">    transform = data_set.get_transform()</span><br><span class="line"></span><br><span class="line">    hard_negative_dataset = CustomHardNegativeMiningDataset(negative_list, jpeg_images, transform=transform)</span><br><span class="line">    image, target, negative_dict = hard_negative_dataset.__getitem__(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(image.shape)</span><br><span class="line">    <span class="built_in">print</span>(target)</span><br><span class="line">    <span class="built_in">print</span>(negative_dict)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="pascal-voc-py"><a href="#pascal-voc-py" class="headerlink" title="pascal_voc.py"></a>pascal_voc.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> torchvision.datasets <span class="keyword">import</span> VOCDetection</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    下载PASCAL VOC数据集</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    dataset = VOCDetection(<span class="string">&#x27;../../data&#x27;</span>, year=<span class="string">&#x27;2007&#x27;</span>, image_set=<span class="string">&#x27;trainval&#x27;</span>, download=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;数据集数目&quot;</span>, <span class="built_in">len</span>(dataset))</span><br><span class="line">    img, target = dataset.__getitem__(<span class="number">1000</span>)</span><br><span class="line">    img = np.array(img)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;目标检测数据集的目标&quot;</span>,target)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;图片尺寸&quot;</span>,img.shape)</span><br><span class="line">    cv2.imshow(<span class="string">&#x27;img&#x27;</span>, img)</span><br><span class="line">    cv2.waitKey(<span class="number">0</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="pascal-voc-car-py"><a href="#pascal-voc-car-py" class="headerlink" title="pascal_voc_car.py"></a>pascal_voc_car.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil  <span class="comment"># 用copyfile这个函数</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> xmltodict</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> check_dir</span><br><span class="line"></span><br><span class="line">suffix_xml = <span class="string">&#x27;.xml&#x27;</span></span><br><span class="line">suffix_jpeg = <span class="string">&#x27;.jpg&#x27;</span></span><br><span class="line"></span><br><span class="line">car_train_path = <span class="string">&#x27;../../data/VOCdevkit/VOC2007/ImageSets/Main/car_train.txt&#x27;</span></span><br><span class="line">car_val_path = <span class="string">&#x27;../../data/VOCdevkit/VOC2007/ImageSets/Main/car_val.txt&#x27;</span></span><br><span class="line"></span><br><span class="line">voc_annotation_dir = <span class="string">&#x27;../../data/VOCdevkit/VOC2007/Annotations/&#x27;</span></span><br><span class="line">voc_jpeg_dir = <span class="string">&#x27;../../data/VOCdevkit/VOC2007/JPEGImages/&#x27;</span></span><br><span class="line"></span><br><span class="line">car_root_dir = <span class="string">&#x27;../../data/voc_car/&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_train_val</span>(<span class="params">data_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    提取指定类别图像，这里取的是含汽车（int(res[2]) == 1）图片的编号</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    samples = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(data_path, mode=<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        lines = file.readlines()</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">            res = line.strip().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(res) == <span class="number">3</span> <span class="keyword">and</span> <span class="built_in">int</span>(res[<span class="number">2</span>]) == <span class="number">1</span>:  <span class="comment"># 选出正样本，res[2]＝＝０是标注者给出难分辨的样本的标签</span></span><br><span class="line">                samples.append(res[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> np.array(samples)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sample_train_val</span>(<span class="params">samples</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    随机采样样本，减少数据集个数（留下1/7）</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> [<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;val&#x27;</span>]:</span><br><span class="line">        dataset = samples[name]</span><br><span class="line">        length = <span class="built_in">len</span>(dataset)</span><br><span class="line"></span><br><span class="line">        random_samples = random.sample(<span class="built_in">range</span>(length), <span class="built_in">int</span>(length / <span class="number">7</span>))</span><br><span class="line">        new_dataset = dataset[random_samples]</span><br><span class="line">        samples[name] = new_dataset</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> samples</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_car</span>(<span class="params">sample_list</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    遍历所有的标注文件，筛选包含car的样本</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    car_samples = <span class="built_in">list</span>()</span><br><span class="line">    <span class="keyword">for</span> sample_name <span class="keyword">in</span> sample_list:</span><br><span class="line">        annotation_path = os.path.join(voc_annotation_dir, sample_name + suffix_xml)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(annotation_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            xml_dict = xmltodict.parse(f)</span><br><span class="line">            <span class="comment"># print(xml_dict)</span></span><br><span class="line"></span><br><span class="line">            bndboxs = <span class="built_in">list</span>()</span><br><span class="line">            objects = xml_dict[<span class="string">&#x27;annotation&#x27;</span>][<span class="string">&#x27;object&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(objects, <span class="built_in">list</span>):</span><br><span class="line">                <span class="keyword">for</span> obj <span class="keyword">in</span> objects:</span><br><span class="line">                    obj_name = obj[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">                    difficult = <span class="built_in">int</span>(obj[<span class="string">&#x27;difficult&#x27;</span>])</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&#x27;car&#x27;</span>.__eq__(obj_name) <span class="keyword">and</span> difficult != <span class="number">1</span>:</span><br><span class="line">                        car_samples.append(sample_name)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(objects, <span class="built_in">dict</span>):</span><br><span class="line">                obj_name = objects[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">                difficult = <span class="built_in">int</span>(objects[<span class="string">&#x27;difficult&#x27;</span>])</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;car&#x27;</span>.__eq__(obj_name) <span class="keyword">and</span> difficult != <span class="number">1</span>:</span><br><span class="line">                    car_samples.append(sample_name)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> car_samples</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_car</span>(<span class="params">car_samples, data_root_dir, data_annotation_dir, data_jpeg_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    保存类别Car的样本图片和标注文件</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> sample_name <span class="keyword">in</span> car_samples:</span><br><span class="line">        src_annotation_path = os.path.join(voc_annotation_dir, sample_name + suffix_xml)</span><br><span class="line">        dst_annotation_path = os.path.join(data_annotation_dir, sample_name + suffix_xml)</span><br><span class="line">        shutil.copyfile(src_annotation_path, dst_annotation_path)</span><br><span class="line"></span><br><span class="line">        src_jpeg_path = os.path.join(voc_jpeg_dir, sample_name + suffix_jpeg)</span><br><span class="line">        dst_jpeg_path = os.path.join(data_jpeg_dir, sample_name + suffix_jpeg)</span><br><span class="line">        shutil.copyfile(src_jpeg_path, dst_jpeg_path)</span><br><span class="line"></span><br><span class="line">    csv_path = os.path.join(data_root_dir, <span class="string">&#x27;car.csv&#x27;</span>)</span><br><span class="line">    np.savetxt(csv_path, np.array(car_samples), fmt=<span class="string">&#x27;%s&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    samples = &#123;<span class="string">&#x27;train&#x27;</span>: parse_train_val(car_train_path), <span class="string">&#x27;val&#x27;</span>: parse_train_val(car_val_path)&#125;  <span class="comment"># 定义一个字典</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;source total&quot;</span>,<span class="built_in">len</span>(samples[<span class="string">&#x27;train&#x27;</span>])+<span class="built_in">len</span>(samples[<span class="string">&#x27;val&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">    samples = sample_train_val(samples)  <span class="comment"># 随机下采样,减少数据量</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;1/7倍&quot;</span>, <span class="built_in">len</span>(samples[<span class="string">&#x27;train&#x27;</span>])+<span class="built_in">len</span>(samples[<span class="string">&#x27;val&#x27;</span>]))</span><br><span class="line">    check_dir(car_root_dir)</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> [<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;val&#x27;</span>]:</span><br><span class="line">        data_root_dir = os.path.join(car_root_dir, name)</span><br><span class="line">        data_annotation_dir = os.path.join(data_root_dir, <span class="string">&#x27;Annotations&#x27;</span>)</span><br><span class="line">        data_jpeg_dir = os.path.join(data_root_dir, <span class="string">&#x27;JPEGImages&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        check_dir(data_root_dir)</span><br><span class="line">        check_dir(data_annotation_dir)</span><br><span class="line">        check_dir(data_jpeg_dir)</span><br><span class="line">        save_car(samples[name], data_root_dir, data_annotation_dir, data_jpeg_dir)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;done&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

































<h3 id="2-1、-x2F-py-x2F-utils-x2F-data-x2F-pascal-voc-py"><a href="#2-1、-x2F-py-x2F-utils-x2F-data-x2F-pascal-voc-py" class="headerlink" title="2.1、 .&#x2F;py&#x2F;utils&#x2F;data&#x2F;pascal_voc.py"></a>2.1、 .&#x2F;py&#x2F;utils&#x2F;data&#x2F;pascal_voc.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> torchvision.datasets <span class="keyword">import</span> VOCDetection</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    下载PASCAL VOC数据集</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    dataset = VOCDetection(<span class="string">&#x27;../../data&#x27;</span>, year=<span class="string">&#x27;2007&#x27;</span>, image_set=<span class="string">&#x27;trainval&#x27;</span>, download=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;数据集数目&quot;</span>, <span class="built_in">len</span>(dataset))</span><br><span class="line">    img, target = dataset.__getitem__(<span class="number">1000</span>)</span><br><span class="line">    img = np.array(img)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;目标检测数据集的目标&quot;</span>,target)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;图片尺寸&quot;</span>,img.shape)</span><br><span class="line">    cv2.imshow(<span class="string">&#x27;img&#x27;</span>, img)</span><br><span class="line">    cv2.waitKey(<span class="number">0</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="2-2、-x2F-py-x2F-utils-x2F-data-x2F-pascal-voc-car-py"><a href="#2-2、-x2F-py-x2F-utils-x2F-data-x2F-pascal-voc-car-py" class="headerlink" title="2.2、 .&#x2F;py&#x2F;utils&#x2F;data&#x2F;pascal_voc_car.py"></a>2.2、 .&#x2F;py&#x2F;utils&#x2F;data&#x2F;pascal_voc_car.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil  <span class="comment"># 用copyfile这个函数</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> xmltodict</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> check_dir</span><br><span class="line"></span><br><span class="line">suffix_xml = <span class="string">&#x27;.xml&#x27;</span></span><br><span class="line">suffix_jpeg = <span class="string">&#x27;.jpg&#x27;</span></span><br><span class="line"></span><br><span class="line">car_train_path = <span class="string">&#x27;../../data/VOCdevkit/VOC2007/ImageSets/Main/car_train.txt&#x27;</span></span><br><span class="line">car_val_path = <span class="string">&#x27;../../data/VOCdevkit/VOC2007/ImageSets/Main/car_val.txt&#x27;</span></span><br><span class="line"></span><br><span class="line">voc_annotation_dir = <span class="string">&#x27;../../data/VOCdevkit/VOC2007/Annotations/&#x27;</span></span><br><span class="line">voc_jpeg_dir = <span class="string">&#x27;../../data/VOCdevkit/VOC2007/JPEGImages/&#x27;</span></span><br><span class="line"></span><br><span class="line">car_root_dir = <span class="string">&#x27;../../data/voc_car/&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_train_val</span>(<span class="params">data_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    提取指定类别图像，这里取的是含汽车（int(res[2]) == 1）图片的编号</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    samples = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(data_path, mode=<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        lines = file.readlines()</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">            res = line.strip().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(res) == <span class="number">3</span> <span class="keyword">and</span> <span class="built_in">int</span>(res[<span class="number">2</span>]) == <span class="number">1</span>:  <span class="comment"># 选出正样本，res[2]＝＝０是标注者给出难分辨的样本的标签</span></span><br><span class="line">                samples.append(res[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> np.array(samples)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sample_train_val</span>(<span class="params">samples</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    随机采样样本，减少数据集个数（留下1/7）</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> [<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;val&#x27;</span>]:</span><br><span class="line">        dataset = samples[name]</span><br><span class="line">        length = <span class="built_in">len</span>(dataset)</span><br><span class="line"></span><br><span class="line">        random_samples = random.sample(<span class="built_in">range</span>(length), <span class="built_in">int</span>(length / <span class="number">7</span>))</span><br><span class="line">        new_dataset = dataset[random_samples]</span><br><span class="line">        samples[name] = new_dataset</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> samples</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_car</span>(<span class="params">sample_list</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    遍历所有的标注文件，筛选包含car的样本</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    car_samples = <span class="built_in">list</span>()</span><br><span class="line">    <span class="keyword">for</span> sample_name <span class="keyword">in</span> sample_list:</span><br><span class="line">        annotation_path = os.path.join(voc_annotation_dir, sample_name + suffix_xml)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(annotation_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            xml_dict = xmltodict.parse(f)</span><br><span class="line">            <span class="comment"># print(xml_dict)</span></span><br><span class="line"></span><br><span class="line">            bndboxs = <span class="built_in">list</span>()</span><br><span class="line">            objects = xml_dict[<span class="string">&#x27;annotation&#x27;</span>][<span class="string">&#x27;object&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(objects, <span class="built_in">list</span>):</span><br><span class="line">                <span class="keyword">for</span> obj <span class="keyword">in</span> objects:</span><br><span class="line">                    obj_name = obj[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">                    difficult = <span class="built_in">int</span>(obj[<span class="string">&#x27;difficult&#x27;</span>])</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&#x27;car&#x27;</span>.__eq__(obj_name) <span class="keyword">and</span> difficult != <span class="number">1</span>:</span><br><span class="line">                        car_samples.append(sample_name)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(objects, <span class="built_in">dict</span>):</span><br><span class="line">                obj_name = objects[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">                difficult = <span class="built_in">int</span>(objects[<span class="string">&#x27;difficult&#x27;</span>])</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;car&#x27;</span>.__eq__(obj_name) <span class="keyword">and</span> difficult != <span class="number">1</span>:</span><br><span class="line">                    car_samples.append(sample_name)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> car_samples</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_car</span>(<span class="params">car_samples, data_root_dir, data_annotation_dir, data_jpeg_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    保存类别Car的样本图片和标注文件</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> sample_name <span class="keyword">in</span> car_samples:</span><br><span class="line">        src_annotation_path = os.path.join(voc_annotation_dir, sample_name + suffix_xml)</span><br><span class="line">        dst_annotation_path = os.path.join(data_annotation_dir, sample_name + suffix_xml)</span><br><span class="line">        shutil.copyfile(src_annotation_path, dst_annotation_path)</span><br><span class="line"></span><br><span class="line">        src_jpeg_path = os.path.join(voc_jpeg_dir, sample_name + suffix_jpeg)</span><br><span class="line">        dst_jpeg_path = os.path.join(data_jpeg_dir, sample_name + suffix_jpeg)</span><br><span class="line">        shutil.copyfile(src_jpeg_path, dst_jpeg_path)</span><br><span class="line"></span><br><span class="line">    csv_path = os.path.join(data_root_dir, <span class="string">&#x27;car.csv&#x27;</span>)</span><br><span class="line">    np.savetxt(csv_path, np.array(car_samples), fmt=<span class="string">&#x27;%s&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    samples = &#123;<span class="string">&#x27;train&#x27;</span>: parse_train_val(car_train_path), <span class="string">&#x27;val&#x27;</span>: parse_train_val(car_val_path)&#125;  <span class="comment"># 定义一个字典</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;source total&quot;</span>,<span class="built_in">len</span>(samples[<span class="string">&#x27;train&#x27;</span>])+<span class="built_in">len</span>(samples[<span class="string">&#x27;val&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">    samples = sample_train_val(samples)  <span class="comment"># 随机下采样,减少数据量</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;1/7倍&quot;</span>, <span class="built_in">len</span>(samples[<span class="string">&#x27;train&#x27;</span>])+<span class="built_in">len</span>(samples[<span class="string">&#x27;val&#x27;</span>]))</span><br><span class="line">    check_dir(car_root_dir)</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> [<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;val&#x27;</span>]:</span><br><span class="line">        data_root_dir = os.path.join(car_root_dir, name)</span><br><span class="line">        data_annotation_dir = os.path.join(data_root_dir, <span class="string">&#x27;Annotations&#x27;</span>)</span><br><span class="line">        data_jpeg_dir = os.path.join(data_root_dir, <span class="string">&#x27;JPEGImages&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        check_dir(data_root_dir)</span><br><span class="line">        check_dir(data_annotation_dir)</span><br><span class="line">        check_dir(data_jpeg_dir)</span><br><span class="line">        save_car(samples[name], data_root_dir, data_annotation_dir, data_jpeg_dir)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;done&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="2-3、-x2F-py-x2F-utils-x2F-data-x2F-create-finetune-data-py"><a href="#2-3、-x2F-py-x2F-utils-x2F-data-x2F-create-finetune-data-py" class="headerlink" title="2.3、 .&#x2F;py&#x2F;utils&#x2F;data&#x2F;create_finetune_data.py"></a>2.3、 .&#x2F;py&#x2F;utils&#x2F;data&#x2F;create_finetune_data.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> selectivesearch</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> check_dir</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> parse_car_csv</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> parse_xml</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> compute_ious</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_annotation_jpeg</span>(<span class="params">annotation_path, jpeg_path, gs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取正负样本（注：忽略属性difficult为True的标注边界框）</span></span><br><span class="line"><span class="string">    正样本：候选建议与标注边界框IoU大于等于0.5</span></span><br><span class="line"><span class="string">    负样本：IoU大于0,小于0.5。为了进一步限制负样本数目，其大小必须大于标注框的1/5</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    img = cv2.imread(jpeg_path)</span><br><span class="line"></span><br><span class="line">    selectivesearch.config(gs, img, strategy=<span class="string">&#x27;q&#x27;</span>)</span><br><span class="line">    <span class="comment"># 计算候选建议</span></span><br><span class="line">    rects = selectivesearch.get_rects(gs)</span><br><span class="line">    <span class="comment"># 获取标注边界框</span></span><br><span class="line">    bndboxs = parse_xml(annotation_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 标注框大小</span></span><br><span class="line">    maximum_bndbox_size = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> bndbox <span class="keyword">in</span> bndboxs:</span><br><span class="line">        xmin, ymin, xmax, ymax = bndbox</span><br><span class="line">        bndbox_size = (ymax - ymin) * (xmax - xmin)</span><br><span class="line">        <span class="keyword">if</span> bndbox_size &gt; maximum_bndbox_size:</span><br><span class="line">            maximum_bndbox_size = bndbox_size</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取候选建议和标注边界框的IoU</span></span><br><span class="line">    iou_list = compute_ious(rects, bndboxs)</span><br><span class="line"></span><br><span class="line">    positive_list = <span class="built_in">list</span>()</span><br><span class="line">    negative_list = <span class="built_in">list</span>()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(iou_list)):</span><br><span class="line">        xmin, ymin, xmax, ymax = rects[i]</span><br><span class="line">        rect_size = (ymax - ymin) * (xmax - xmin)</span><br><span class="line"></span><br><span class="line">        iou_score = iou_list[i]</span><br><span class="line">        <span class="keyword">if</span> iou_list[i] &gt;= <span class="number">0.5</span>:</span><br><span class="line">            <span class="comment"># 正样本</span></span><br><span class="line">            positive_list.append(rects[i])</span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt; iou_list[i] &lt; <span class="number">0.5</span> <span class="keyword">and</span> rect_size &gt; maximum_bndbox_size / <span class="number">5.0</span>:</span><br><span class="line">            <span class="comment"># 负样本</span></span><br><span class="line">            negative_list.append(rects[i])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> positive_list, negative_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    car_root_dir = <span class="string">&#x27;../../data/voc_car/&#x27;</span></span><br><span class="line">    finetune_root_dir = <span class="string">&#x27;../../data/finetune_car/&#x27;</span></span><br><span class="line">    check_dir(finetune_root_dir)</span><br><span class="line"></span><br><span class="line">    gs = selectivesearch.get_selective_search()</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> [<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;val&#x27;</span>]:</span><br><span class="line">        src_root_dir = os.path.join(car_root_dir, name)</span><br><span class="line">        src_annotation_dir = os.path.join(src_root_dir, <span class="string">&#x27;Annotations&#x27;</span>)</span><br><span class="line">        src_jpeg_dir = os.path.join(src_root_dir, <span class="string">&#x27;JPEGImages&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        dst_root_dir = os.path.join(finetune_root_dir, name)</span><br><span class="line">        dst_annotation_dir = os.path.join(dst_root_dir, <span class="string">&#x27;Annotations&#x27;</span>)</span><br><span class="line">        dst_jpeg_dir = os.path.join(dst_root_dir, <span class="string">&#x27;JPEGImages&#x27;</span>)</span><br><span class="line">        check_dir(dst_root_dir)</span><br><span class="line">        check_dir(dst_annotation_dir)</span><br><span class="line">        check_dir(dst_jpeg_dir)</span><br><span class="line"></span><br><span class="line">        total_num_positive = <span class="number">0</span></span><br><span class="line">        total_num_negative = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        samples = parse_car_csv(src_root_dir)  <span class="comment"># 拿到根目录下的csv 文件</span></span><br><span class="line">        <span class="comment"># 复制csv文件</span></span><br><span class="line">        src_csv_path = os.path.join(src_root_dir, <span class="string">&#x27;car.csv&#x27;</span>)</span><br><span class="line">        dst_csv_path = os.path.join(dst_root_dir, <span class="string">&#x27;car.csv&#x27;</span>)</span><br><span class="line">        shutil.copyfile(src_csv_path, dst_csv_path)</span><br><span class="line">        <span class="keyword">for</span> sample_name <span class="keyword">in</span> samples:</span><br><span class="line">            since = time.time()</span><br><span class="line"></span><br><span class="line">            src_annotation_path = os.path.join(src_annotation_dir, sample_name + <span class="string">&#x27;.xml&#x27;</span>)</span><br><span class="line">            src_jpeg_path = os.path.join(src_jpeg_dir, sample_name + <span class="string">&#x27;.jpg&#x27;</span>)</span><br><span class="line">            <span class="comment"># 获取正负样本</span></span><br><span class="line">            positive_list, negative_list = parse_annotation_jpeg(src_annotation_path, src_jpeg_path, gs)</span><br><span class="line">            total_num_positive += <span class="built_in">len</span>(positive_list)</span><br><span class="line">            total_num_negative += <span class="built_in">len</span>(negative_list)</span><br><span class="line"></span><br><span class="line">            dst_annotation_positive_path = os.path.join(dst_annotation_dir, sample_name + <span class="string">&#x27;_1&#x27;</span> + <span class="string">&#x27;.csv&#x27;</span>)</span><br><span class="line">            dst_annotation_negative_path = os.path.join(dst_annotation_dir, sample_name + <span class="string">&#x27;_0&#x27;</span> + <span class="string">&#x27;.csv&#x27;</span>)</span><br><span class="line">            dst_jpeg_path = os.path.join(dst_jpeg_dir, sample_name + <span class="string">&#x27;.jpg&#x27;</span>)</span><br><span class="line">            <span class="comment"># 保存图片</span></span><br><span class="line">            shutil.copyfile(src_jpeg_path, dst_jpeg_path)</span><br><span class="line">            <span class="comment"># 保存正负样本标注</span></span><br><span class="line">            np.savetxt(dst_annotation_positive_path, np.array(positive_list), fmt=<span class="string">&#x27;%d&#x27;</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            np.savetxt(dst_annotation_negative_path, np.array(negative_list), fmt=<span class="string">&#x27;%d&#x27;</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">            time_elapsed = time.time() - since</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;parse &#123;&#125;.png in &#123;:.0f&#125;m &#123;:.0f&#125;s&#x27;</span>.<span class="built_in">format</span>(sample_name, time_elapsed // <span class="number">60</span>, time_elapsed % <span class="number">60</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s positive num: %d&#x27;</span> % (name, total_num_positive))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s negative num: %d&#x27;</span> % (name, total_num_negative))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;done&#x27;</span>)</span><br></pre></td></tr></table></figure>







<h2 id="2-4、-x2F-py-x2F-utils-x2F-data-x2F-create-classifier-data-py"><a href="#2-4、-x2F-py-x2F-utils-x2F-data-x2F-create-classifier-data-py" class="headerlink" title="2.4、 .&#x2F;py&#x2F;utils&#x2F;data&#x2F;create_classifier_data.py"></a>2.4、 .&#x2F;py&#x2F;utils&#x2F;data&#x2F;create_classifier_data.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> xmltodict</span><br><span class="line"><span class="keyword">import</span> selectivesearch</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> check_dir</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> parse_car_csv</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> parse_xml</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> iou</span><br><span class="line"><span class="keyword">from</span> utils.util <span class="keyword">import</span> compute_ious</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># train</span></span><br><span class="line"><span class="comment"># positive num: 67</span></span><br><span class="line"><span class="comment"># negative num: 34674</span></span><br><span class="line"><span class="comment"># val</span></span><br><span class="line"><span class="comment"># positive num: 75</span></span><br><span class="line"><span class="comment"># negative num: 26277</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_annotation_jpeg</span>(<span class="params">annotation_path, jpeg_path, gs</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    获取正负样本（注：忽略属性difficult为True的标注边界框）</span></span><br><span class="line"><span class="string">    正样本：标注边界框</span></span><br><span class="line"><span class="string">    负样本：IoU大于0，小于等于0.3。为了进一步限制负样本数目，其大小必须大于最大标注框的1/5</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    img = cv2.imread(jpeg_path)</span><br><span class="line"></span><br><span class="line">    selectivesearch.config(gs, img, strategy=<span class="string">&#x27;q&#x27;</span>)</span><br><span class="line">    <span class="comment"># 计算候选建议</span></span><br><span class="line">    rects = selectivesearch.get_rects(gs)</span><br><span class="line">    <span class="comment"># 获取标注边界框</span></span><br><span class="line">    bndboxs = parse_xml(annotation_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 标注框大小</span></span><br><span class="line">    maximum_bndbox_size = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> bndbox <span class="keyword">in</span> bndboxs:</span><br><span class="line">        xmin, ymin, xmax, ymax = bndbox</span><br><span class="line">        bndbox_size = (ymax - ymin) * (xmax - xmin)</span><br><span class="line">        <span class="keyword">if</span> bndbox_size &gt; maximum_bndbox_size:</span><br><span class="line">            maximum_bndbox_size = bndbox_size</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取候选建议和标注边界框的IoU</span></span><br><span class="line">    iou_list = compute_ious(rects, bndboxs)</span><br><span class="line"></span><br><span class="line">    positive_list = <span class="built_in">list</span>()</span><br><span class="line">    negative_list = <span class="built_in">list</span>()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(iou_list)):</span><br><span class="line">        xmin, ymin, xmax, ymax = rects[i]</span><br><span class="line">        rect_size = (ymax - ymin) * (xmax - xmin)</span><br><span class="line"></span><br><span class="line">        iou_score = iou_list[i]</span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt; iou_score &lt;= <span class="number">0.3</span> <span class="keyword">and</span> rect_size &gt; maximum_bndbox_size / <span class="number">5.0</span>:</span><br><span class="line">            <span class="comment"># 负样本</span></span><br><span class="line">            negative_list.append(rects[i])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bndboxs, negative_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    car_root_dir = <span class="string">&#x27;../../data/voc_car/&#x27;</span></span><br><span class="line">    classifier_root_dir = <span class="string">&#x27;../../data/classifier_car/&#x27;</span></span><br><span class="line">    check_dir(classifier_root_dir)</span><br><span class="line"></span><br><span class="line">    gs = selectivesearch.get_selective_search()  <span class="comment"># 实例化,生成ｇｓ对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> [<span class="string">&#x27;train&#x27;</span>, <span class="string">&#x27;val&#x27;</span>]:</span><br><span class="line">        src_root_dir = os.path.join(car_root_dir, name)</span><br><span class="line">        src_annotation_dir = os.path.join(src_root_dir, <span class="string">&#x27;Annotations&#x27;</span>)</span><br><span class="line">        src_jpeg_dir = os.path.join(src_root_dir, <span class="string">&#x27;JPEGImages&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        dst_root_dir = os.path.join(classifier_root_dir, name)</span><br><span class="line">        dst_annotation_dir = os.path.join(dst_root_dir, <span class="string">&#x27;Annotations&#x27;</span>)</span><br><span class="line">        dst_jpeg_dir = os.path.join(dst_root_dir, <span class="string">&#x27;JPEGImages&#x27;</span>)</span><br><span class="line">        check_dir(dst_root_dir)</span><br><span class="line">        check_dir(dst_annotation_dir)</span><br><span class="line">        check_dir(dst_jpeg_dir)</span><br><span class="line"></span><br><span class="line">        total_num_positive = <span class="number">0</span></span><br><span class="line">        total_num_negative = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        samples = parse_car_csv(src_root_dir)  <span class="comment"># 在src_root_dir目录下加载ｃｓｖ文件</span></span><br><span class="line">        <span class="comment"># 复制csv文件</span></span><br><span class="line">        src_csv_path = os.path.join(src_root_dir, <span class="string">&#x27;car.csv&#x27;</span>)</span><br><span class="line">        dst_csv_path = os.path.join(dst_root_dir, <span class="string">&#x27;car.csv&#x27;</span>)</span><br><span class="line">        shutil.copyfile(src_csv_path, dst_csv_path)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> sample_name <span class="keyword">in</span> samples:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                since = time.time()</span><br><span class="line"></span><br><span class="line">                src_annotation_path = os.path.join(src_annotation_dir, sample_name + <span class="string">&#x27;.xml&#x27;</span>)</span><br><span class="line">                src_jpeg_path = os.path.join(src_jpeg_dir, sample_name + <span class="string">&#x27;.jpg&#x27;</span>)</span><br><span class="line">                <span class="comment"># 获取正负样本</span></span><br><span class="line">                positive_list, negative_list = parse_annotation_jpeg(src_annotation_path, src_jpeg_path, gs)</span><br><span class="line">                total_num_positive += <span class="built_in">len</span>(positive_list)</span><br><span class="line">                total_num_negative += <span class="built_in">len</span>(negative_list)</span><br><span class="line"></span><br><span class="line">                dst_annotation_positive_path = os.path.join(dst_annotation_dir, sample_name + <span class="string">&#x27;_1&#x27;</span> + <span class="string">&#x27;.csv&#x27;</span>)</span><br><span class="line">                dst_annotation_negative_path = os.path.join(dst_annotation_dir, sample_name + <span class="string">&#x27;_0&#x27;</span> + <span class="string">&#x27;.csv&#x27;</span>)</span><br><span class="line">                dst_jpeg_path = os.path.join(dst_jpeg_dir, sample_name + <span class="string">&#x27;.jpg&#x27;</span>)</span><br><span class="line">                <span class="comment"># 保存图片</span></span><br><span class="line">                shutil.copyfile(src_jpeg_path, dst_jpeg_path)</span><br><span class="line">                <span class="comment"># 保存正负样本标注</span></span><br><span class="line">                np.savetxt(dst_annotation_positive_path, np.array(positive_list), fmt=<span class="string">&#x27;%d&#x27;</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                np.savetxt(dst_annotation_negative_path, np.array(negative_list), fmt=<span class="string">&#x27;%d&#x27;</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">                time_elapsed = time.time() - since</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;parse &#123;&#125;.png in &#123;:.0f&#125;m &#123;:.0f&#125;s&#x27;</span>.<span class="built_in">format</span>(sample_name, time_elapsed // <span class="number">60</span>, time_elapsed % <span class="number">60</span>))</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> err:</span><br><span class="line">                <span class="built_in">print</span>(err)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s positive num: %d&#x27;</span> % (name, total_num_positive))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s negative num: %d&#x27;</span> % (name, total_num_negative))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;done&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="2-5、-x2F-py-x2F-utils-x2F-data-x2F-create-bbox-regression-data-py"><a href="#2-5、-x2F-py-x2F-utils-x2F-data-x2F-create-bbox-regression-data-py" class="headerlink" title="2.5、 &#x2F;py&#x2F;utils&#x2F;data&#x2F;create_bbox_regression_data.py"></a>2.5、 &#x2F;py&#x2F;utils&#x2F;data&#x2F;create_bbox_regression_data.py</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> utils.util <span class="keyword">as</span> util</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从voc_car/train目录中提取标注边界框坐标</span></span><br><span class="line"><span class="string">    从finetune_car/train目录中提取训练集正样本坐标（IoU&gt;=0.5），进一步提取IoU&gt;0.6的边界框</span></span><br><span class="line"><span class="string">    数据集保存在bbox_car目录下</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    voc_car_train_dir = <span class="string">&#x27;../../data/voc_car/train&#x27;</span></span><br><span class="line">    <span class="comment"># ground truth</span></span><br><span class="line">    gt_annotation_dir = os.path.join(voc_car_train_dir, <span class="string">&#x27;Annotations&#x27;</span>)</span><br><span class="line">    jpeg_dir = os.path.join(voc_car_train_dir, <span class="string">&#x27;JPEGImages&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    classifier_car_train_dir = <span class="string">&#x27;../../data/finetune_car/train&#x27;</span></span><br><span class="line">    <span class="comment"># positive</span></span><br><span class="line">    positive_annotation_dir = os.path.join(classifier_car_train_dir, <span class="string">&#x27;Annotations&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    dst_root_dir = <span class="string">&#x27;../../data/bbox_regression/&#x27;</span></span><br><span class="line">    dst_jpeg_dir = os.path.join(dst_root_dir, <span class="string">&#x27;JPEGImages&#x27;</span>)</span><br><span class="line">    dst_bndbox_dir = os.path.join(dst_root_dir, <span class="string">&#x27;bndboxs&#x27;</span>)</span><br><span class="line">    dst_positive_dir = os.path.join(dst_root_dir, <span class="string">&#x27;positive&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    util.check_dir(dst_root_dir)</span><br><span class="line">    util.check_dir(dst_jpeg_dir)</span><br><span class="line">    util.check_dir(dst_bndbox_dir)</span><br><span class="line">    util.check_dir(dst_positive_dir)</span><br><span class="line"></span><br><span class="line">    samples = util.parse_car_csv(voc_car_train_dir)</span><br><span class="line">    res_samples = <span class="built_in">list</span>()</span><br><span class="line">    total_positive_num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> sample_name <span class="keyword">in</span> samples:</span><br><span class="line">        <span class="comment"># 提取正样本边界框坐标（IoU&gt;=0.5）</span></span><br><span class="line">        positive_annotation_path = os.path.join(positive_annotation_dir, sample_name + <span class="string">&#x27;_1.csv&#x27;</span>)</span><br><span class="line">        positive_bndboxes = np.loadtxt(positive_annotation_path, dtype=np.<span class="built_in">int</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        <span class="comment"># 提取标注边界框</span></span><br><span class="line">        gt_annotation_path = os.path.join(gt_annotation_dir, sample_name + <span class="string">&#x27;.xml&#x27;</span>)</span><br><span class="line">        bndboxs = util.parse_xml(gt_annotation_path)</span><br><span class="line">        <span class="comment"># 计算符合条件（IoU&gt;0.6）的候选建议</span></span><br><span class="line">        positive_list = <span class="built_in">list</span>()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(positive_bndboxes.shape) == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(positive_bndboxes) != <span class="number">0</span>:</span><br><span class="line">            scores = util.iou(positive_bndboxes, bndboxs)</span><br><span class="line">            <span class="keyword">if</span> np.<span class="built_in">max</span>(scores) &gt; <span class="number">0.6</span>:</span><br><span class="line">                positive_list.append(positive_bndboxes)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(positive_bndboxes.shape) == <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">for</span> positive_bndboxe <span class="keyword">in</span> positive_bndboxes:</span><br><span class="line">                scores = util.iou(positive_bndboxe, bndboxs)</span><br><span class="line">                <span class="keyword">if</span> np.<span class="built_in">max</span>(scores) &gt; <span class="number">0.6</span>:</span><br><span class="line">                    positive_list.append(positive_bndboxe)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 如果存在正样本边界框（IoU&gt;0.6），那么保存相应的图片以及标注边界框</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(positive_list) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="comment"># 保存图片</span></span><br><span class="line">            jpeg_path = os.path.join(jpeg_dir, sample_name + <span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">            dst_jpeg_path = os.path.join(dst_jpeg_dir, sample_name + <span class="string">&quot;.jpg&quot;</span>)</span><br><span class="line">            shutil.copyfile(jpeg_path, dst_jpeg_path)</span><br><span class="line">            <span class="comment"># 保存标注边界框</span></span><br><span class="line">            dst_bndbox_path = os.path.join(dst_bndbox_dir, sample_name + <span class="string">&quot;.csv&quot;</span>)</span><br><span class="line">            np.savetxt(dst_bndbox_path, bndboxs, fmt=<span class="string">&#x27;%s&#x27;</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="comment"># 保存正样本边界框</span></span><br><span class="line">            dst_positive_path = os.path.join(dst_positive_dir, sample_name + <span class="string">&quot;.csv&quot;</span>)</span><br><span class="line">            np.savetxt(dst_positive_path, np.array(positive_list), fmt=<span class="string">&#x27;%s&#x27;</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">            total_positive_num += <span class="built_in">len</span>(positive_list)</span><br><span class="line">            res_samples.append(sample_name)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;save &#123;&#125; done&#x27;</span>.<span class="built_in">format</span>(sample_name))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;-------- &#123;&#125; 不符合条件&#x27;</span>.<span class="built_in">format</span>(sample_name))</span><br><span class="line"></span><br><span class="line">    dst_csv_path = os.path.join(dst_root_dir, <span class="string">&#x27;car.csv&#x27;</span>)</span><br><span class="line">    np.savetxt(dst_csv_path, res_samples, fmt=<span class="string">&#x27;%s&#x27;</span>, delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;total positive num: &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(total_positive_num))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;done&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


            </div>

            
                <div class="post-copyright-info">
                    
<div class="article-copyright-info-container">
    <ul class="copyright-info-content">
        <li class="post-title">
            <span class="type">本文标题</span>：<span class="content">RCNN代码复现</span>
        </li>
        <li class="post-author">
            <span class="type">本文作者</span>：<span class="content">bigfly</span>
        </li>
        <li class="post-time">
            <span class="type">创建时间</span>：<span class="content">2023-04-21 23:26:11</span>
        </li>
        <li class="post-link">
            <span class="type">本文链接</span>：<span class="content">2023/04/21/RCNN代码复现/</span>
        </li>
        <li class="post-license">
            <span class="type">版权声明</span>：<span class="content">本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！</span>
        </li>
    </ul>
    <div class="copy-copyright-info flex-center tooltip" data-content="复制版权信息" data-offset-y="-2px">
        <i class="fa-solid fa-copy"></i>
    </div>
</div>

                </div>
            

            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                               rel="prev"
                               href="/2023/04/22/%E6%9C%BA%E5%99%A8%E8%A7%86%E8%A7%89%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F/"
                            >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                                <span class="title flex-center">
                                <span class="post-nav-title-item">机器视觉检测系统</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                            </a>
                        </div>
                    
                    
                        <div class="article-next">
                            <a class="next"
                               rel="next"
                               href="/2023/04/19/%E5%8D%9A%E5%AE%A2%E6%BA%90%E7%A0%81%E7%9A%84%E6%8B%89%E5%9B%9E%E4%B8%8E%E6%8E%A8%E9%80%81/"
                            >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">博客源码的拉回与推送</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                                <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                            </a>
                        </div>
                    
                </div>
            

            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%B7%A5%E7%A8%8B%E7%BB%93%E6%9E%84"><span class="nav-number">1.</span> <span class="nav-text">一、工程结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB"><span class="nav-number">2.</span> <span class="nav-text">二、源码解读</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#py-x2F"><span class="nav-number">2.1.</span> <span class="nav-text">py&#x2F;</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#bbox-regression-py"><span class="nav-number">2.1.1.</span> <span class="nav-text">bbox_regression.py</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#car-detector-py"><span class="nav-number">2.1.2.</span> <span class="nav-text">car_detector.py</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#finetune-py"><span class="nav-number">2.1.3.</span> <span class="nav-text">finetune.py</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#linear-svm-py"><span class="nav-number">2.1.4.</span> <span class="nav-text">linear_svm.py</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#selectivesearch-py"><span class="nav-number">2.1.5.</span> <span class="nav-text">selectivesearch.py</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#utils-x2F"><span class="nav-number">2.1.6.</span> <span class="nav-text">utils&#x2F;</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#data"><span class="nav-number">2.1.6.1.</span> <span class="nav-text">data</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#create-bbox-regression-data-py"><span class="nav-number">2.1.6.1.1.</span> <span class="nav-text">create_bbox_regression_data.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#create-classifier-data-py"><span class="nav-number">2.1.6.1.2.</span> <span class="nav-text">create_classifier_data.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#create-finetune-data-py"><span class="nav-number">2.1.6.1.3.</span> <span class="nav-text">create_finetune_data.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#custom-batch-sampler-py"><span class="nav-number">2.1.6.1.4.</span> <span class="nav-text">custom_batch_sampler.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#custom-bbox-regression-dataset-py"><span class="nav-number">2.1.6.1.5.</span> <span class="nav-text">custom_bbox_regression_dataset.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#custom-classifier-dataset-py"><span class="nav-number">2.1.6.1.6.</span> <span class="nav-text">custom_classifier_dataset.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#custom-finetune-dataset-py"><span class="nav-number">2.1.6.1.7.</span> <span class="nav-text">custom_finetune_dataset.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#custom-hard-negative-mining-dataset-py"><span class="nav-number">2.1.6.1.8.</span> <span class="nav-text">custom_hard_negative_mining_dataset.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#pascal-voc-py"><span class="nav-number">2.1.6.1.9.</span> <span class="nav-text">pascal_voc.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#pascal-voc-car-py"><span class="nav-number">2.1.6.1.10.</span> <span class="nav-text">pascal_voc_car.py</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1%E3%80%81-x2F-py-x2F-utils-x2F-data-x2F-pascal-voc-py"><span class="nav-number">2.2.</span> <span class="nav-text">2.1、 .&#x2F;py&#x2F;utils&#x2F;data&#x2F;pascal_voc.py</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2%E3%80%81-x2F-py-x2F-utils-x2F-data-x2F-pascal-voc-car-py"><span class="nav-number">3.</span> <span class="nav-text">2.2、 .&#x2F;py&#x2F;utils&#x2F;data&#x2F;pascal_voc_car.py</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3%E3%80%81-x2F-py-x2F-utils-x2F-data-x2F-create-finetune-data-py"><span class="nav-number">4.</span> <span class="nav-text">2.3、 .&#x2F;py&#x2F;utils&#x2F;data&#x2F;create_finetune_data.py</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4%E3%80%81-x2F-py-x2F-utils-x2F-data-x2F-create-classifier-data-py"><span class="nav-number">5.</span> <span class="nav-text">2.4、 .&#x2F;py&#x2F;utils&#x2F;data&#x2F;create_classifier_data.py</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5%E3%80%81-x2F-py-x2F-utils-x2F-data-x2F-create-bbox-regression-data-py"><span class="nav-number">6.</span> <span class="nav-text">2.5、 &#x2F;py&#x2F;utils&#x2F;data&#x2F;create_bbox_regression_data.py</span></a></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            
<footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
                <span>2023</span> -
            
            2025
            
                &nbsp;<i class="fas fa-heart icon-animate"></i>
                &nbsp;<a href="/">bigfly</a>
            
        </div>
        
            <script async data-pjax
                    src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                
                
                    总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.6.1</a>
        </div>
        
        
            <div class="deploy-info info-item">
                
                    本站由 <span class="tooltip" data-content="Netlify"><img src="/images/deploy-provider/netlify.png"></span> 提供部署服务
                
            </div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script>




    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/code-block.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/lazyload.js"></script>


<div class="post-scripts pjax">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script>
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script>
        
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/toc.js"></script>
        
    
</div>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.6.1/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
